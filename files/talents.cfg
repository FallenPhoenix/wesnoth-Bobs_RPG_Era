#textdomain wesnoth-Bobs_RPG_Era

####################################################################################
# Talent Definitions
####################################################################################

#define TRAIT_WEAPONCRAFT
[trait]
	id=weaponcraft
	male_name= _ "weaponcraft"
	female_name= _ "female^weaponcraft"
	description= _ "You've learned to take great care of your weapon, knowing that preparation is often decisive on the battlefield. Weaponcraft allows you to use raw materials from your inventory to improve your melee weapon. This is done by right-clicking on your character."
[/trait]
#enddef

#define TRAIT_ROUSER
[trait]
	id=rouser
	male_name= _ "rouser"
	female_name= _ "female^rouser"
	description= _ "With fine words and a steely resolve you are able to rouse your allies into performing deeds of bravery. A unit that has been roused begins their turn with two extra movement points. This is done by right-clicking on an adjacent friendly unit. It can only be done once a turn."
[/trait]
#enddef

#define TRAIT_RIDER
[trait]
	id=rider
	male_name= _ "rider"
	female_name= _ "female^rider"
	description= _ "You are trained in the art of riding. Any animal with the 'mount' ability can be mounted by a rider. This is done by right-clicking on an adjacent unit. To dismount, right-click again on an empty adjacent hex. Whilst mounted your max moves, movetype and pierce resistances are modified."
[/trait]
#enddef

#define TRAIT_HERBALISM
[trait]
	id=herbalism
	male_name= _ "herbalism"
	female_name= _ "female^herbalism"
	description= _ "You have a thorough knowledge of plants and their medicinal properties. Herbalism allows you to use raw materials from your inventory to apply medicinal balms. This is done by right-clicking on your character."
[/trait]
#enddef

#define TRAIT_TAMER
[trait]
	id=tamer
	male_name= _ "tamer"
	female_name= _ "female^tamer"
	description= _ "You have a natural affinity with beasts of the wild. Each turn, instead of attacking, a tamer can attempt to tame a creature or monster. This is done by right-clicking on a suitable adjacent unit. A taming attempt has a 60% of success. If the attempt fails the creature will lash out; if it is successful, the creature will join the side of the tamer. However, every subsequent turn there is a 30% chance that the creature will become wild again."
[/trait]
#enddef

#define TRAIT_PICKPOCKET
[trait]
	id=pickpocket
	male_name= _ "pickpocket"
	female_name= _ "female^pickpocket"
	description= _ "Your fingers have a habit of slipping into other people's purses. Each turn, instead of attacking, a pickpocket can attempt to steal gold from a unit (but only those likely to carry some). This is done by right-clicking on a suitable adjacent unit. A pickpocket attempt has a 60% of success. If the attempt fails the unit will notice and strike out; if it is successful, the pickpocket earns a small random sum of gold. You can only ever try to pickpocket a unit once, even if the attempt fails. Richer pickings can be found in the pockets of higher level units."
[/trait]
#enddef

#define TRAIT_TRAPPER
[trait]
	id=trapper
	male_name= _ "trapper"
	female_name= _ "female^trapper"
	description= _ "You are skilled at ensnaring both man and beast alike. A trapper can use raw materials from their inventory to create traps. This is done by right-clicking on your character. To set a trap you must right-click on an empty non-water adjacent hex. Traps remain on the map until a unit sets it off or a trapper picks it up."
[/trait]
#enddef

#define TRAIT_CONCOCTION
[trait]
	id=concoction
	male_name= _ "concoction"
	female_name= _ "female^concoction"
	description= _ "You have mastered the art of fusing the elements into potent fluids. Concoction allows you to use raw materials from your inventory to create potions. This is done by right-clicking on your character."
[/trait]
#enddef

#define TRAIT_CONJURER
[trait]
	id=conjurer
	male_name= _ "conjurer"
	female_name= _ "female^conjurer"
	description= _ "You have the power to conjure creatures out of the ether. Conjuring allows you to use raw materials from your inventory to create new units. This is done by right-clicking on an empty non-water adjacent hex. Every turn there is a 30% chance the magic will wane and the conjured creature will vanish."
[/trait]
#enddef

#define TRAIT_CASTING
[trait]
	id=casting
	male_name= _ "casting"
	female_name= _ "female^casting"
	description= _ "You have learned to harness the flux of magic and bind it to your will. Casting allows you to use magic scrolls. This is done by right-clicking on the target of the spell."
[/trait]
#enddef

####################################################################################
# Talent Menu
####################################################################################

#define BOB_CHOOSE_TALENT

[message]
	image=wesnoth-icon.png
	speaker=narrator
	caption=_ "Character Design"
	message= _ "Choose a talent for your character."

#####################
# Warrior
#####################

# Weaponcraft

[option]
message= "&icons/traits/weaponcraft.png=<span color='{BOB_GREEN}'>" + _"Weaponcraft" + "</span>
<span size='small'>" + _"You are skilled at preparing and maintaining your weapon.
Effect: Allows you to use raw materials to improve melee weapons." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].warrior_level_number greater_than_equal_to 1}
[/show_if]
[command]
#{VARIABLE character[$side_number].talent weaponcraft}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_WEAPONCRAFT}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY scorpion_tail ulox_rock}
[/command]
[/option]

# Rouser

[option]
message= "&icons/traits/rouser.png=<span color='{BOB_GREEN}'>"+ _"Rouser" + "</span>
<span size='small'>" + _"You are able to rouse allies into performing deeds of bravery.
Effect: Allows you to give others a temporary movement bonus." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].warrior_level_number greater_than_equal_to 1}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent rouser}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_ROUSER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY energy_cocktail speed_serum}
	{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.variables.has_roused no})}
[/command]
[/option]

# Rider
[option]
message= "&icons/traits/rider.png=<span color='{BOB_GREEN}'>" + _"Rider" + "</span>
<span size='small'>" + _"You are trained in the art of riding.
Effect: Allows you to mount and ride horses." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].warrior_level_number greater_than_equal_to 1}
	{BOB_CONDITION unit.type equals "Human Lieutenant"}
	# Disable the option
	{BOB_CONDITION unit.type equals "Disable This Option"}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent rider}
	{BOB_RANDOM_INVENTORY energy_cocktail speed_serum}
	{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.variables.moves_before_mounting $stored_unit.max_moves})}
	[object]
		silent=yes
		duration=forever
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[effect]
			apply_to=variation
			name=Mounted
		[/effect]
	[/object]
	{BOB_REDRAW}
[/command]
[/option]

#####################
# Ranger
#####################

# Herbalism

[option]
message= "&icons/traits/herbalism.png=<span color='{BOB_GREEN}'>" + _"Herbalism" + "</span>
<span size='small'>" + _"You have a thorough knowledge of plants and their medicinal properties.
Effect: Allows you to use raw materials to create simple balms." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].ranger_level_number greater_than_equal_to 1}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent herbalism}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_HERBALISM}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY antidote huanti_leaves}
[/command]
[/option]

# Tamer

[option]
message= "&icons/traits/tamer.png=<span color='{BOB_GREEN}'>" + _"Tamer" + "</span>
<span size='small'>" + _"You have a natural affinity with beasts of the wild.
Effect: Allows you to temporarily tame creatures." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].ranger_level_number greater_than_equal_to 1}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent tamer}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_TAMER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY scorpion_tail fang}
[/command]
[/option]

#####################
# Vagabond
#####################

# Trapper

[option]
message= "&icons/traits/trapper.png=<span color='{BOB_GREEN}'>" + _"Trapper" + "</span>
<span size='small'>" + _"You are skilled at ensnaring both man and beast alike.
Effect: Allows you to make and set traps." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].vagabond_level_number greater_than_equal_to 1}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent trapper}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_TRAPPER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY poison net}
[/command]
[/option]

# Pickpocket

[option]
message= "&icons/traits/pickpocket.png=<span color='{BOB_GREEN}'>" + _"Pickpocket" + "</span>
<span size='small'>" + _"Your fingers have a habit of slipping into other people's purses.
Effect: Allows you to steal gold from other units." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].vagabond_level_number greater_than_equal_to 1}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent pickpocket}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_PICKPOCKET}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY gold_nugget fang}
[/command]
[/option]

#####################
# Magician
#####################

# Concoction

[option]
message= "&icons/traits/concoction.png=<span color='{BOB_GREEN}'>" + _"Concoction" + "</span>
<span size='small'>" + _"You have mastered the art of fusing the elements into potent fluids.
Effect: Allows you to mix raw materials to create potions." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].magician_level_number greater_than_equal_to 1}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent concoction}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_CONCOCTION}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY endurance_potion mind_juice}
[/command]
[/option]

# Conjurer

[option]
message= "&icons/traits/conjurer.png=<span color='{BOB_GREEN}'>" + _"Conjurer" + "</span>
<span size='small'>" + _"You have the power to conjure creatures out of the ether.
Effect: Allows you use raw materials to create new units." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].magician_level_number greater_than_equal_to 1}
[/show_if]
[command]
	#{VARIABLE character[$side_number].talent conjurer}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_CONJURER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY skull clay}
[/command]
[/option]

# Casting

#[option]
#message= {MENU_IMG_TXT "icons/traits/casting.png" _"<span color='{BOB_GREEN}'>Casting</span>
#<span size='small'>You have learned to harness the flux of magic and bind it to your will.
#Effect: Allows you to cast spells.</span>"}
#[show_if]
#	{BOB_CONDITION character[$side_number].magician_level_number greater_than_equal_to 1}
#	[/show_if]
#[command]
#{VARIABLE character[$side_number].talent casting}
#{BOB_RANDOM_INVENTORY energy_cocktail speed_serum}
#[/command]
#[/option]

[/message]
#enddef


####################################################################################
# Weaponcraft
####################################################################################

#define BOB_TALENT_WEAPONCRAFT
[event]
	name=start
	
[set_menu_item]
	id=Weaponcraft
	description=_ "menu^Use Weaponcraft"
	image=misc/weaponcraft.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals weaponcraft}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[filter_wml]
				[modifications]
					[trait]
						id=weaponcraft
					[/trait]
				[/modifications]
				attacks_left=1
			[/filter_wml]
		[/have_unit]
	[/show_if]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/weaponcraft.png
	caption=_ "Weaponcraft"
	message=_ "Weaponcraft allows you to use raw materials from your inventory to improve your melee weapon. The effects of weaponcraft are temporary and will wear off after your next combat - or if you equip a new weapon."

[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
	{CLEAR_VARIABLE finished}
[/command]
[/option]

[option]
message= "&inventory/materials/ulox_rock.png=$inventory[$side_number].ulox_rock=<span color='{BOB_GREEN}'>" + _"Sharpen With Ulox Rock" + "</span>
<span size='small'>" + _"+1 to melee damage" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 1}
	{BOB_CONDITION character[$side_number].melee_weapon_temp_damage_bonus less_than 1}
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].ulox_rock add -1}
	{BOB_ADD_WEAPON_SPECIAL melee $character[$side_number].melee_weapon_variable TEMP_SHARPENED}
	{BOB_MODIFY_WEAPON melee damage 1 $character[$side_number].melee_weapon_variable}
	{VARIABLE_OP character[$side_number].melee_weapon_temp_damage_bonus add 1}
	{BOB_PRINT_G _"$character[$side_number].name has used Weaponcraft."
	      _"female^$character[$side_number].name has used Weaponcraft."}
[/command]
[/option]

# If the weapon is already 'sharpened', this prevents the special being applied multiple times
[option]
message= "&inventory/materials/ulox_rock.png" "$inventory[$side_number].ulox_rock=<span color='{BOB_GREEN}'>" + _"Sharpen With Ulox Rock" + "</span>
<span size='small'>" + _"+1 to melee damage" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 1}
	{BOB_CONDITION character[$side_number].melee_weapon_temp_damage_bonus greater_than_equal_to 1}
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].ulox_rock add -1}
	{BOB_MODIFY_WEAPON melee damage 1 $character[$side_number].melee_weapon_variable}
	{VARIABLE_OP character[$side_number].melee_weapon_temp_damage_bonus add 1}
	{BOB_PRINT_G _"$character[$side_number].name has used Weaponcraft."
	      _"female^$character[$side_number].name has used Weaponcraft."}
[/command]
[/option]

[option]
message= "&inventory/materials/slime.png=$inventory[$side_number].slime=<span color='{BOB_GREEN}'>" + _"Smear With Slime" + "</span>
<span size='small'>" + _"Gives your melee weapon the slows special" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
	[have_unit]
		x,y=$x1,$y1
		[not]
		[filter_wml]
			[attack]
				[specials]
					[slow]
						id=temp_slow
					[/slow]
				[/specials]
			[/attack]
		[/filter_wml]
		[/not]
	[/have_unit]
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].slime add -1}
	{BOB_ADD_WEAPON_SPECIAL melee $character[$side_number].melee_weapon_variable TEMP_SLOW}
	{BOB_PRINT_G _"$character[$side_number].name has used Weaponcraft."
	      _"female^$character[$side_number].name has used Weaponcraft."}
[/command]
[/option]

[option]
message= "&inventory/materials/scorpion_tail.png=$inventory[$side_number].scorpion_tail=<span color='{BOB_GREEN}'>" + _"Rub With Scorpion Tail" + "</span>
<span size='small'>" + _"Makes your melee weapon poisonous" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
	[have_unit]
		x,y=$x1,$y1
		[not]
		[filter_wml]
			[attack]
				[specials]
					[poison]
						id=temp_poison
					[/poison]
				[/specials]
			[/attack]
		[/filter_wml]
		[/not]
	[/have_unit]
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].scorpion_tail add -1}
	{BOB_ADD_WEAPON_SPECIAL melee $character[$side_number].melee_weapon_variable TEMP_POISON}
	{BOB_PRINT_G _"$character[$side_number].name has used Weaponcraft."
	      _"female^$character[$side_number].name has used Weaponcraft."}
[/command]
[/option]

[/message]
[/do]
[/while]
[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Rouser
####################################################################################

#define BOB_TALENT_ROUSER	
[event]
	name=start
	
[set_menu_item]
	id=Rouse
	description=_ "menu^Rouse"
	image=misc/rouser.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals rouser}
		[have_unit]
			x,y=$x1,$y1
			is_enemy=no
			[not]
				ability=temp_roused
			[/not]
			[not]
				side=$side_number
				canrecruit=yes
			[/not]
		[/have_unit]
	[/show_if]
	[filter_location]
		[filter]
			side=$side_number
			canrecruit=yes
			[filter_wml]
				[modifications]
					[trait]
						id=rouser
					[/trait]
				[/modifications]
				[not]
					[variables]
						has_roused=yes
					[/variables]
				[/not]
				attacks_left=1
			[/filter_wml]
		[/filter]
		radius=1
	[/filter_location]
	[command]
		{BOB_MODIFY_MOVEMENT x=$x1 y=$y1 2}
		{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE_OP stored_unit.moves add 2})}
		{BOB_ADD_ABILITY ROUSED}
		[floating_text]
			x,y=$x1,$y1
			text="<span color='green'>" + _ "Roused" + "</span>"
		[/floating_text]
		{BOB_STORE_UNIT canrecruit=yes side=$side_number ({VARIABLE stored_unit.variables.has_roused yes})}
	[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Rider
####################################################################################

#define BOB_TALENT_RIDER
[event]
	name=start
	
# Dismount

[set_menu_item]
	id=Dismount
	description=_ "menu^Dismount"
	image=misc/feet.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals rider}
		[not]
			[have_unit]
				x,y=$x1,$y1
			[/have_unit]
		[/not]
	[/show_if]
	[filter_location]
		[not]
			terrain="Xt,Xu,Xv,*^Xo,Xos,Qt,Qlf,Ql,Qxu,Md^Xm,Mm^Xm,Wo,_off^_usr"
		[/not]
		[and]
			[filter]
				side=$side_number
				canrecruit=yes
				[filter_wml]
					variation=Mounted
					[modifications]
						[trait]
							id=rider
						[/trait]
					[/modifications]
					[variables]
						[not]
							moves_before_mounting=0
						[/not]
					[/variables]
					attacks_left=1
				[/filter_wml]
			[/filter]
			radius=1
		[/and]
	[/filter_location]
[command]
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
		{VARIABLE temp_x $stored_unit.x}
		{VARIABLE temp_y $stored_unit.y}
		{VARIABLE temp_moves $stored_unit.moves}
		{VARIABLE temp_name $stored_unit.variables.mount_name}
		{VARIABLE stored_unit.attack[0].icon $character[$side_number].melee_weapon_icon}
		{VARIABLE stored_unit.attack[1].icon $character[$side_number].ranged_weapon_icon}
		{VARIABLE stored_unit.moves $stored_unit.variables.moves_before_mounting}
		{VARIABLE stored_unit.variables.moves_before_mounting 0}
		{VARIABLE_OP stored_unit.moves add -1}
	)}
	[object]
		silent=yes
		duration=forever
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[effect]
			apply_to=variation
			name="$none"
		[/effect]
	[/object]
	{BOB_TELEPORT side=$side_number canrecruit=yes $x1 $y1}
	{BOB_REDRAW}
	[unit]
		side=$side_number
		type=BOB_Horse
		random_traits=no
		name=$temp_name
		x=$temp_x
		y=$temp_y
		moves=$temp_moves
	[/unit]

	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
	{CLEAR_VARIABLE temp_moves}
	{CLEAR_VARIABLE temp_name}
[/command]
[/set_menu_item] 

# Mount

[set_menu_item]
	id=Mount
	description=_ "menu^Mount"
	image=misc/hand.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals rider}
		[have_unit]
			x,y=$x1,$y1
			ability=mount
		[/have_unit]
	[/show_if]
	[filter_location]
		[filter]
		side=$side_number
		canrecruit=yes
		[filter_wml]
			[modifications]
				[trait]
					id=rider
				[/trait]
			[/modifications]
			[not]
				variation=Mounted
			[/not]
			[not]
				moves=0
			[/not]
			attacks_left=1
		[/filter_wml]
		[/filter]
		radius=1
	[/filter_location]
[command]
	
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
		# Remember how many moves the character had left (-1 for mounting)
		{VARIABLE stored_unit.variables.moves_before_mounting $stored_unit.moves}
		{VARIABLE_OP stored_unit.variables.moves_before_mounting add -1}
		# Set character's moves to the horse's moves
		{VARIABLE stored_unit.moves $unit.moves}
		# Remember the horse's name
		{VARIABLE stored_unit.variables.mount_name $unit.name}
		# Show the character's icons
		{VARIABLE stored_unit.attack[0].icon $character[$side_number].melee_weapon_icon}
		{VARIABLE stored_unit.attack[1].icon $character[$side_number].ranged_weapon_icon}
	)}
	[object]
		silent=yes
		duration=forever
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[effect]
			apply_to=variation
			name=Mounted
		[/effect]
	[/object]
	[kill]
		x=$x1
		y=$y1
		animate=no
	[/kill]
	{BOB_TELEPORT side=$side_number canrecruit=yes $x1 $y1}
	{BOB_REDRAW}
[/command]
[/set_menu_item]
[/event]

[event]
	name="turn refresh"
	first_time_only=no
	[store_unit]
		[filter]
			side=$side_number
			canrecruit=yes
			[filter_wml]
				variation=Mounted
			[/filter_wml]
		[/filter]
		variable=unit
	[/store_unit]
		{VARIABLE unit.variables.moves_before_mounting $stored_unit.moves}
		{VARIABLE unit.variables.moves_before_mounting $stored_unit.moves}
	[unstore_unit]
		variable=units
	[/unstore_unit]
[/event]
#enddef

####################################################################################
# Herbalism
####################################################################################

#define BOB_USED_HERBALISM ITEM_ID ITEM_NUM
{VARIABLE_OP inventory[$side_number].{ITEM_ID} add -{ITEM_NUM}}
{BOB_PRINT_G _"$character[$side_number].name has used Herbalism."
      _"female^$character[$side_number].name has used Herbalism."}
{BOB_REDRAW}
#enddef
#define BOB_TALENT_HERBALISM
[event]
	name=start
	
[set_menu_item]
	id=Herbalism
	description=_ "menu^Use Herbalism"
	image=misc/herbalism.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals herbalism}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[filter_wml]
				[modifications]
					[trait]
						id=herbalism
					[/trait]
				[/modifications]
				attacks_left=1
			[/filter_wml] 
		[/have_unit]
	[/show_if]
	
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/herbalism.png
	caption=_ "Herbalism"
	message=_ "Herbalism allows you to use raw materials from your inventory to make medicinal balms and broths. The effects are instant."

[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
	{CLEAR_VARIABLE finished}
[/command]
[/option]

[option]
message= "&inventory/materials/huanti_leaves.png=$inventory[$side_number].huanti_leaves=<span color='{BOB_GREEN}'>" + _"Use Huanti Leaves" + "</span>
<span size='small'>" + _"Restores 4 hitpoints" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].huanti_leaves greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent healing when at max hp	
	[if]
		[have_unit]
			x,y=$x1,$y1
			[not]
				[filter_wml]
					hitpoints=$this_unit.max_hitpoints
				[/filter_wml]
			[/not]
		[/have_unit]
		[then]
			{BOB_MODIFY_HITPOINTS 4 no 0}
			{BOB_USED_HERBALISM huanti_leaves 1}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= "&inventory/materials/ulox_rock.png=$inventory[$side_number].ulox_rock=<span color='{BOB_GREEN}'>" + _"Use Ulox Rocks" + "</span>
<span size='small'>" + _"+1 max hitpoints (uses 2 rocks)" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 2}
[/show_if]
[command]
	{BOB_MODIFY_HITPOINTS 0 no 1}
	{BOB_USED_HERBALISM ulox_rock 2}
[/command]
[/option]

[option]
message= "&inventory/materials/yoll_tree_bark.png=$inventory[$side_number].yoll_tree_bark=<span color='{BOB_GREEN}'>" + _"Use Yoll Tree Bark" + "</span>
<span size='small'>" + _"-1 max experience" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].yoll_tree_bark greater_than_equal_to 1}
[/show_if]
[command]
	{BOB_STORE ({VARIABLE temp_max_xp $stored.max_experience})}
	# Prevent making max xp too low
	[if]
		{BOB_CONDITION temp_max_xp greater_than_equal_to 11}
		[then]
			{BOB_MODIFY_EXPERIENCE -1}
			{BOB_USED_HERBALISM yoll_tree_bark 1}
		[/then]
	[/if]
	{CLEAR_VARIABLE temp_max_xp}
[/command]
[/option]

[option]
message= "&inventory/materials/scorpion_tail.png=$inventory[$side_number].scorpion_tail=<span color='{BOB_GREEN}'>" + _"Use Scorpion Tail" + "</span>
<span size='small'>" + _"Cures poison" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent curing when not poisoned
	[if]
		[have_unit]
			x,y=$x1,$y1
			[filter_wml]
				[status]
					poisoned=yes
				[/status]
			[/filter_wml]
		[/have_unit]
		[then]
			{BOB_ALTER_STATUS x=$x1 y=$y1 poisoned no}
			{BOB_USED_HERBALISM scorpion_tail 1}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= "&inventory/materials/slime.png=$inventory[$side_number].slime=<span color='{BOB_GREEN}'>" + _"Use Slime" + "</span>
<span size='small'>" + _"Removes slow" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent unslowing when not slowed
	[if]
		[have_unit]
			x,y=$x1,$y1
			[filter_wml]
				[status]
					slowed=yes
				[/status]
			[/filter_wml]
		[/have_unit]
		[then]
			{BOB_ALTER_STATUS x=$x1 y=$y1 slowed no}
			{BOB_USED_HERBALISM slime 1}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= "&inventory/materials/fang.png=$inventory[$side_number].fang=<span color='{BOB_GREEN}'>" + _"Use Fang" + "</span>
<span size='small'>" + _"Restores moves" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].fang greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent restoring moves when at max moves
	[if]
		[have_unit]
			x,y=$x1,$y1
			[not]
				[filter_wml]
					moves=$this_unit.max_moves
				[/filter_wml]
			[/not]
		[/have_unit]
		[then]
			{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.moves $stored_unit.max_moves})}
			{BOB_MODIFY_EXPERIENCE 0}
			{BOB_USED_HERBALISM fang 1}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= "&inventory/materials/dragon_tail.png=$inventory[$side_number].dragon_tail=<span color='{BOB_GREEN}'>" + _"Use Dragon Tail" + "</span>
<span size='small'>" + _"+20% resistance to fire damage" + "</span>"
[show_if]
	{BOB_CONDITION inventory[$side_number].dragon_tail greater_than_equal_to 1}
[/show_if]
[command]
	{BOB_MODIFY_RESISTANCE x=$x1 y=$y1 fire -20}
	{BOB_USED_HERBALISM dragon_tail 1}
[/command]
[/option]

[/message]
[/do]
[/while]
[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Tamer
####################################################################################

#define BOB_TALENT_TAMER
[event]
	name=start
[set_menu_item]
	id=Tame
	description=_ "menu^Tame"
	image=misc/hand.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals tamer}
		[have_unit]
			x,y=$x1,$y1
			[not]
				side=$side_number
			[/not]
			[not]
				ability=tamed
			[/not]
			[and]
				race=monster
				[or]
					race=bats
				[/or]
				[or]
					type=wolf
				[/or]
				[or]
					type=gryphon
				[/or]
				[or]
					race=animal
				[/or]
			[/and]
		[/have_unit]
	[/show_if]
	[filter_location]
		[filter]
			side=$side_number
			canrecruit=yes
			[filter_wml]
				[modifications]
					[trait]
						id=tamer
					[/trait]
				[/modifications]
				attacks_left=1
			[/filter_wml]
		[/filter]
		radius=1
	[/filter_location]
[command]
	
	# Get the variables of tamer
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
		{VARIABLE temp_x $stored_unit.x}
		{VARIABLE temp_y $stored_unit.y}
		{VARIABLE temp_type $stored_unit.type}
		{VARIABLE stored_unit.attacks_left 0}
	)}
	
	# Simulate a taming animation
	
	[animate_unit]
		flag=attack
		with_bars=no
		hits=yes
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[primary_attack]
			range=melee
		[/primary_attack]
		[facing]
			x,y=$x1,$y1
		[/facing]
	[/animate_unit]
	
	{BOB_DELAY 200}
	
	# 60% chance of successfully taming the creature
	{RANDOM 1..10}
	[if]
		{BOB_CONDITION random less_than_equal_to 6}
		[then]
			{BOB_ADD_ABILITY TAMED}
			[store_unit]
				[filter]
					x,y=$x1,$y1
				[/filter]
				variable=stored_unit
			[/store_unit]
			{VARIABLE stored_unit.variables.original_side $stored_unit.side}
			
			{VARIABLE stored_unit.side $side_number}
			{VARIABLE stored_unit.moves $stored_unit.max_moves}
			{VARIABLE stored_unit.attacks_left 1}
			{VARIABLE stored_unit.upkeep 0}
			{BOB_SOUND bite-small.ogg}	
			[unstore_unit]
				variable=stored_unit
				text= _ "Tamed"
				{COLOR_HEAL}
			[/unstore_unit]
			{BOB_DELAY 100}
		[/then]
	[/if]
		
		
	# 40% chance of being attacked by creature
	[if]
		{BOB_CONDITION random greater_than 6}
		[then]
			# Calculate the damage
			[store_unit]
				[filter]
					side=$side_number
					canrecruit=yes
				[/filter]
				variable=stored_unit
			[/store_unit]
			{VARIABLE temp_damage $unit.attack[0].damage}
			{VARIABLE_OP temp_damage multiply $stored_unit.resistance.$unit.attack[0].type}
			{VARIABLE_OP temp_damage divide 100}
			{VARIABLE_OP stored_unit.hitpoints add -$temp_damage}
			
			# Simulate an attack animation
			[animate_unit]
				flag=attack
				with_bars=yes
				hits=yes
				[filter]
					x=$x1
					y=$y1
				[/filter]
				[primary_attack]
					range=melee
				[/primary_attack]
				[facing]
					x,y=$temp_x,$temp_y
				[/facing]
			[/animate_unit]
		
			{BOB_SOUND {SOUND_LIST:HUMAN_HIT}}
			[unstore_unit]
				variable=stored_unit
				text="$temp_damage"
				{COLOR_HARM}
			[/unstore_unit]
		[/then]
	[/if]		
	
	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
	{CLEAR_VARIABLE temp_damage}
	{CLEAR_VARIABLE temp_type}
	
	[/command]
	[/set_menu_item]
[/event]

# Test if the animal reverts to the wild

[event]
	name="side turn"
	first_time_only=no
	
	[store_unit]
		[filter]
			ability=tamed
			side=$side_number
		[/filter]
		variable=beasts
		kill=no
	[/store_unit]

	{FOREACH beasts i}
			
		{RANDOM 1..10}
		
		[if]
			{BOB_CONDITION random less_than_equal_to 3}
			[then]
				{SCROLL_TO $beasts[$i].x $beasts[$i].y}
				{BOB_SOUND bite-small.ogg}
				{VARIABLE beasts[$i].side $beasts[$i].variables.original_side}
				{VARIABLE beasts[$i].moves $beasts[$i].max_moves}
				{VARIABLE beasts[$i].attacks_left 1}
				{VARIABLE beasts[$i].upkeep $beasts[$i].level}
				[unstore_unit]
					variable=beasts[$i]
					text=_ "Wild"
					{COLOR_HARM}
				[/unstore_unit]
				{BOB_REMOVE_ABILITY TAMED}
			[/then]
		[/if]
		[if]
			{BOB_CONDITION random greater_than 3}
			[then]
				[unstore_unit]
					variable=beasts[$i]
				[/unstore_unit]
			[/then]
		[/if]
	{NEXT i}

	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE beasts}
	
[/event]
#enddef

####################################################################################
# Pickpocket
####################################################################################

#define BOB_TALENT_PICKPOCKET
[event]
	name=start
[set_menu_item]
	id=Pickpocket
	description=_ "menu^Pickpocket"
	image=misc/hand.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals pickpocket}
		[have_unit]
			x,y=$x1,$y1
			[not]
				side=$side_number
				canrecruit=yes
			[/not]
			[not]
				[filter_wml]
					[variables]
						pickpocketed=yes
					[/variables]
				[/filter_wml]
			[/not]
			[and]
				race=human
				[or]
					race=elf
				[/or]
				[or]
					race=dwarf
				[/or]
				[or]
					race=orc
				[/or]
				[or]
					race=goblin
				[/or]
				[or]
					race=drake
				[/or]
				[or]
					race=lizard
				[/or]
				[or]
					race=ogre
				[/or]
				[or]
					race=troll
				[/or]
				[or]
					race="dark elf"
				[/or]
				[or]
					race=kalifa
				[/or]
				[or]
					race=vampire
				[/or]
				[or]
					race=sidhe
				[/or]
				[or]
					race=aragwaith
				[/or]
				[or]
					race=calydonianrace
				[/or]
				[or]
					race=lavinian
				[/or]
				[or]
					race=nemidian
				[/or]
			[/and]
		[/have_unit]
	[/show_if]
	[filter_location]
		[filter]
			side=$side_number
			canrecruit=yes
			[filter_wml]
				[modifications]
					[trait]
						id=pickpocket
					[/trait]
				[/modifications]
				attacks_left=1
			[/filter_wml]
		[/filter]
		radius=1
	[/filter_location]
[command]
	
	# Get the variables of pickpocketer
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
		{VARIABLE temp_x $stored_unit.x}
		{VARIABLE temp_y $stored_unit.y}
		{VARIABLE temp_type $stored_unit.type}
		{VARIABLE stored_unit.attacks_left 0}
	)}
	
	# Simulate a theft animation
	
	[animate_unit]
		flag=attack
		with_bars=no
		hits=yes
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[primary_attack]
			range=melee
		[/primary_attack]
		[facing]
			x,y=$x1,$y1
		[/facing]
	[/animate_unit]
	
	{BOB_DELAY 200}
	
	# 60% chance of successful pickpocket
	{RANDOM 1..10}
	[if]
		{BOB_CONDITION random less_than_equal_to 6}
		[then]
			# Calculate how much gold is stolen
			# (lvl 0: 1-3g)  (lvl 1: 2-6g)  (lvl 2: 3-9g)  (lvl 3: 4-12g)  (lvl 4: 5-15g)
			{RANDOM 1..3}
			{VARIABLE temp_gold $unit.level}
			{VARIABLE_OP temp_gold add 1}
			{VARIABLE_OP temp_gold multiply $random}
			
			# If the unit being pickpocketed is a leader...
			[if]
				[have_unit]
					x,y=$x1,$y1
					canrecruit=yes
				[/have_unit]
				[then]
					[store_side]
						side=$unit.side
						variable=victim
					[/store_side]
					# If the leader is broke, no gold can be stolen
					[if]
						{BOB_CONDITION victim.gold less_than_equal_to 0}
						[then]
							{BOB_PRINT_G _"$character[$side_number].name tried to pickpocket $unit.name|, but their pockets were empty."
							           _"female^$character[$side_number].name tried to pickpocket $unit.name|, but their pockets were empty."}
						[/then]
					[/if]
					# If the leader has less gold than is about to be stolen, adjust the amount
					[if]
						{BOB_CONDITION victim.gold less_than $temp_gold}
						{BOB_CONDITION victim.gold greater_than 0}
						[then]
							{VARIABLE temp_gold $victim.gold}
							{BOB_GOLD $side_number $temp_gold}
							{BOB_GOLD $unit.side -$temp_gold}
							{BOB_SOUND gold.ogg}
							[floating_text]
								side=$side_number
								canrecruit=yes
								text= "<span color='{BOB_COLOR_GOLD}'>" + _"$temp_gold|g" + "</span>"
							[/floating_text]
							{BOB_DELAY 100}
						[/then]
					[/if]
					# If the leader has enough gold
					[if]
						{BOB_CONDITION victim.gold greater_than_equal_to $temp_gold}
						[then]
							{BOB_GOLD $side_number $temp_gold}
							{BOB_GOLD $unit.side -$temp_gold}
							{BOB_SOUND gold.ogg}
							[floating_text]
								side=$side_number
								canrecruit=yes
								text= "<span color='{BOB_COLOR_GOLD}'>" + _"$temp_gold|g" + "</span>"
							[/floating_text]
							{BOB_DELAY 100}
						[/then]
					[/if]
				[/then]
			[/if]
			# If the unit being pickpocketed is not a leader...
			[if]
				[have_unit]
					x,y=$x1,$y1
					canrecruit=no
				[/have_unit]
				[then]
					{BOB_GOLD $side_number $temp_gold}
					{BOB_SOUND gold.ogg}
					[floating_text]
						side=$side_number
						canrecruit=yes
						text="<span color='{BOB_COLOR_GOLD}'>" + _"$temp_gold|g" + "</span>"
					[/floating_text]
					{BOB_DELAY 100}
				[/then]
			[/if]
		
		[/then]
	[/if]
	
		
	# 40% chance of being noticed, and attacked
	[if]
		{BOB_CONDITION random greater_than 6}
		[then]
			# Random Angry Message
			{IF_VAR character[$side_number].gender not_equals female (
				[then]
					[switch]
						variable=random
						{BOB_DICTIONARY 7  _"Thief!" temp_msg}
						{BOB_DICTIONARY 8  _"Don't try that again, you scoundrel!" temp_msg}
						{BOB_DICTIONARY 9  _"Off with your fingers!" temp_msg}
						{BOB_DICTIONARY 10 _"Be off with you, dirty pickpocket!" temp_msg}
					[/switch]
				[/then]
				[else]
					[switch]
						variable=random
						{BOB_DICTIONARY 7  _"female^Thief!" temp_msg}
						{BOB_DICTIONARY 8  _"female^Don't try that again, you scoundrel!" temp_msg}
						{BOB_DICTIONARY 9  _"female^Off with your fingers!" temp_msg}
						{BOB_DICTIONARY 10 _"female^Be off with you, dirty pickpocket!" temp_msg}
					[/switch]
				[/else]
			)}
			[message]
				speaker=unit
				message=$temp_msg
			[/message]
			
			# Simulate an attack animation
			[animate_unit]
				flag=attack
				with_bars=yes
				hits=yes
				[filter]
					x=$x1
					y=$y1
				[/filter]
				[primary_attack]
					range=melee
				[/primary_attack]
				[facing]
					x,y=$temp_x,$temp_y
				[/facing]
			[/animate_unit]
			
			# Deal 4 damage
			[object]
				silent=yes
				duration=forever
				[filter]
					canrecruit=yes
					side=$side_number
				[/filter]
				[effect]
					apply_to=hitpoints
					increase=-4
				[/effect]
			[/object]
			{BOB_SOUND {SOUND_LIST:HUMAN_HIT}}
			[floating_text]
				canrecruit=yes
				side=$side_number
				text="<span color='red'>4</span>"
			[/floating_text]
		[/then]
	[/if]		
	
	# Ensure the unit cannot be pickpocketed again
	{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.variables.pickpocketed yes})}
					
	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE temp_gold}
	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
	{CLEAR_VARIABLE temp_damage}
	{CLEAR_VARIABLE temp_type}
	{CLEAR_VARIABLE temp_msg}
	
	[/command]
	[/set_menu_item]
[/event]
#enddef

####################################################################################
# Trapper
####################################################################################

#define BOB_MAKE_TRAP_OBJECT RAW_ID TRAP_ID STRING DESCRIPTION TRAP_MSG
[option]
	message= "&icons/recipes/{TRAP_ID}_recipe.png=$inventory[$side_number].{RAW_ID} / $inventory[$side_number].{TRAP_ID}=<span color='{BOB_GREEN}'>" + {STRING} + "</span>
<span size='small'>" + {DESCRIPTION} + "</span>"
	[show_if]
		{BOB_CONDITION inventory[$side_number].{RAW_ID} greater_than_equal_to 1}
	[/show_if]
	[command]
		{VARIABLE_OP inventory[$side_number].{RAW_ID} add -1}
		{VARIABLE_OP inventory[$side_number].{TRAP_ID} add 1}
		{VARIABLE created_item {TRAP_MSG}}
		{BOB_PRINT_G _"$character[$side_number].name has made $created_item|."
		      _"female^$character[$side_number].name has made $created_item|."}
		{BOB_REDRAW}
	[/command]
[/option]
#enddef

#define BOB_SET_TRAP_OBJECT ID IMAGE NAME DESCRIPTION TRAP_MSG
[option]
	message= "&inventory/misc_items/{ID}.png=$inventory[$side_number].{ID}=<span color='{BOB_GREEN}'>" + {NAME} + "</span>
<span size='small'>" + {DESCRIPTION} + "</span>"
	[show_if]
		{BOB_CONDITION inventory[$side_number].{ID} greater_than_equal_to 1}
		[have_location]
			x,y=$x1,$y1
			[not]
				find_in={ID}_xy
			[/not]
		[/have_location]
	[/show_if]
	[command]
		{VARIABLE_OP inventory[$side_number].{ID} add -1}
		{PLACE_IMAGE items/{IMAGE} $x1 $y1}
		[store_locations]
			variable={ID}_xy
			find_in={ID}_xy
			[or]
				x,y=$x1,$y1
			[/or]
		[/store_locations]
		{VARIABLE used_item {TRAP_MSG}}
		{BOB_PRINT_G _"$character[$side_number].name has set $used_item|."
		      _"female^$character[$side_number].name has set $used_item|."}
		{CLEAR_VARIABLE finished}
	[/command]
[/option]
#enddef

#define BOB_PICK_TRAP_OBJECT TRAP_ID TRAP_MSG
[event]
	name=moveto
	first_time_only=no
	[filter]
		canrecruit=yes
		[filter_location]
			find_in={TRAP_ID}_xy
		[/filter_location]
		[filter_wml]
			[modifications]
				[trait]
					id=trapper
				[/trait]
			[/modifications]
		[/filter_wml]
	[/filter]
	{VARIABLE picked_item {TRAP_MSG}}
	{BOB_PRINT_G _"$character[$side_number].name has picked up $picked_item|."
	      _"female^$character[$side_number].name has picked up $picked_item|."}
	{BOB_SOUND skeleton-hit-2.ogg}
	{CLEAR_VARIABLE picked_item}
	{VARIABLE_OP inventory[$side_number].{TRAP_ID} add 1}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable={TRAP_ID}_xy
		find_in={TRAP_ID}_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]
#enddef

#define BOB_TALENT_TRAPPER
[event]
	name=start

# Make Trap
	
[set_menu_item]
	id=Make_Trap
	description=_ "menu^Make Trap"
	image=misc/trapper.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals trapper}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[filter_wml]
				[modifications]
					[trait]
						id=trapper
					[/trait]
				[/modifications]
				attacks_left=1
			[/filter_wml] 
		[/have_unit]
	[/show_if]
	
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]
[message]
	speaker=narrator
	image=icons/traits/trapper.png
	caption=_ "Make Trap"
	message=_ "Trapper allows you to use raw materials from your inventory to construct traps. Any traps you make will be added to your inventory. To set a trap you must right-click on an empty adjacent hex."

	[option]
		message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
		[command]
			{CLEAR_VARIABLE finished}
		[/command]
	[/option]

	{BOB_MAKE_TRAP_OBJECT  ulox_rock       bomb    _"Use Ulox Rock"       _"Creates Bomb Trap"    _"a bomb trap"}
	{BOB_MAKE_TRAP_OBJECT  scorpion_tail   poison  _"Use Scorpion Tail"   _"Creates Poison Trap"  _"a poison trap"}
	{BOB_MAKE_TRAP_OBJECT  yoll_tree_bark  net     _"Use Yoll Tree Bark"  _"Creates Net Trap"     _"a net trap"}

[/message]
{CLEAR_VARIABLE created_item}
[/do]
[/while]
[/command]
[/set_menu_item]

# Set Trap

[set_menu_item]
	id=Set_Trap
	description=_ "menu^Set Trap"
	image=misc/trapper.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals trapper}
		[not]
			[have_unit]
				x,y=$x1,$y1
			[/have_unit]
		[/not]
	[/show_if]
	[filter_location]
		[not]
			terrain="Xt,Xu,Xv,*^Xo,Xos,Qt,Qlf,Ql,Qxu,Md^Xm,Mm^Xm,Wo,Ww,_off^_usr"
		[/not]
		[and]
			[filter]
				side=$side_number
				canrecruit=yes
				[filter_wml]
					[modifications]
						[trait]
							id=trapper
						[/trait]
					[/modifications]
					attacks_left=1
				[/filter_wml]
			[/filter]
			radius=1
		[/and]
	[/filter_location]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]
[message]
	speaker=narrator
	image=icons/traits/trapper.png
	caption=_ "Set Trap"
	message=_ "Trapper allows you to set traps on the ground. Traps remain in play unless they are triggered or a trapper picks them up. You cannot set more than one of the same trap on a hex. Remember, all units are affected by traps - even friendly ones."

	[option]
		message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
		[command]
			{CLEAR_VARIABLE finished}
		[/command]
	[/option]
	
	{BOB_SET_TRAP_OBJECT  bomb    bomb.png
	_"Bomb"    _"A trap that does 12 hitpoints of damage when stepped on"  _"a bomb trap"}
	{BOB_SET_TRAP_OBJECT  poison  potion-poison.png
	_"Poison"  _"A trap that poisons when stepped on"                      _"a poison trap"}
	{BOB_SET_TRAP_OBJECT  net     net.png
	_"Net"     _"A trap that slows when stepped on"                        _"a net trap"}

[/message]
{CLEAR_VARIABLE used_item}
[/do]
[/while]
[/command]
[/set_menu_item]

[/event]

#####################
# Triggering Traps
#####################

# Poison Trap
{BOB_PICK_TRAP_OBJECT poison _"a poison trap"}
[event]
	name=moveto
	first_time_only=no
	[filter]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=undead
					[/trait]
				[/modifications]
			[/filter_wml]
			[or]
				[filter_wml]
					[modifications]
						[trait]
							id=mechanical
						[/trait]
					[/modifications]
				[/filter_wml]
			[/or]
		[/not]
		[filter_location]
			find_in=poison_xy
		[/filter_location]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=trapper
					[/trait]
				[/modifications]
			[/filter_wml]
		[/not]
	[/filter]
	{BOB_ALTER_STATUS x=$x1 y=$y1 poisoned yes}
	[floating_text]
		x,y=$x1,$y1
		text="<span color='red'>" + _ "Poisoned" + "</span>"
	[/floating_text]
	{BOB_SOUND poison.ogg}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=poison_xy
		find_in=poison_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]

# Bomb Trap
{BOB_PICK_TRAP_OBJECT bomb _"a bomb trap"}
[event]
	name=moveto
	first_time_only=no
	[filter]
		[filter_location]
			find_in=bomb_xy
		[/filter_location]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=trapper
					[/trait]
				[/modifications]
			[/filter_wml]
		[/not]
	[/filter]
	{BOB_SOUND explosion.ogg}
	[item]
		x,y=$x1,$y1
		halo="projectiles/fire-burst-small-1.png:75,projectiles/fire-burst-small-2.png:75,projectiles/fire-burst-small-3.png:75,projectiles/fire-burst-small-4.png:75,projectiles/fire-burst-small-5.png:75,projectiles/fire-burst-small-6.png:75,projectiles/fire-burst-small-7.png:75,projectiles/fire-burst-small-8.png:75" 
	[/item]
	#{BOB_DELAY 300}
	[floating_text]
		x,y=$x1,$y1
		text="<span color='red'>12</span>"
	[/floating_text]
	{BOB_MODIFY_HITPOINTS -12 no 0}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=bomb_xy
		find_in=bomb_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]

# Net Trap
{BOB_PICK_TRAP_OBJECT net _"a net trap"}
[event]
	name=moveto
	first_time_only=no
	[filter]
		[filter_location]
			find_in=net_xy
		[/filter_location]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=trapper
					[/trait]
				[/modifications]
			[/filter_wml]
		[/not]
	[/filter]
	{BOB_SOUND net.wav}
	[floating_text]
		x,y=$x1,$y1
		text="<span color='red'>" + _ "Slowed" + "</span>"
	[/floating_text]
	{BOB_ALTER_STATUS x=$x1 y=$y1 slowed yes}
	
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=net_xy
		find_in=net_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]
#enddef

####################################################################################
# Concoction
####################################################################################

#define BOB_CONCOCTION_OBJECT RAW1_ID RAW2_ID POTION_ID STRING DESCRIPTION POTION_MESSAGE
# FIXME: When no potions in inventory, it should print zero number instead of empty field.
[option]
	message= "&icons/recipes/{POTION_ID}_recipe.png=$inventory[$side_number].{RAW1_ID} / $inventory[$side_number].{RAW2_ID} / $inventory[$side_number].{POTION_ID}=<span color='{BOB_GREEN}'>" + {STRING} + "</span>
<span size='small'>" + {DESCRIPTION} + "</span>"
	[show_if]
		{BOB_CONDITION inventory[$side_number].{RAW1_ID} greater_than_equal_to 1}
		{BOB_CONDITION inventory[$side_number].{RAW2_ID} greater_than_equal_to 1}
	[/show_if]
	[command]
		{VARIABLE_OP inventory[$side_number].{RAW1_ID} add -1}
		{VARIABLE_OP inventory[$side_number].{RAW2_ID} add -1}
		{VARIABLE_OP inventory[$side_number].{POTION_ID} add 1}
		{VARIABLE concocted_item {POTION_MESSAGE}}
		{BOB_PRINT_G _"$character[$side_number].name has concocted $concocted_item|."
		      _"female^$character[$side_number].name has concocted $concocted_item|."}
	[/command]
[/option]
#enddef

#define BOB_TALENT_CONCOCTION
[event]
	name=start
	
[set_menu_item]
	id=Concoction
	description=_ "menu^Use Concoction"
	image=misc/concoction.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals concoction}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[filter_wml]
				[modifications]
					[trait]
						id=concoction
					[/trait]
				[/modifications]
				attacks_left=1
			[/filter_wml]
		[/have_unit]
	[/show_if]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/concoction.png
	caption=_ "Concoction"
	message=_ "Concoction allows you to create potions by mixing two raw materials. Any potions you make will be added to your inventory."

	[option]
	message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
		[command]
			{CLEAR_VARIABLE finished}
		[/command]
	[/option]

	# Health Potion
	[option]
		message= "&icons/recipes/health_potion_recipe.png=$inventory[$side_number].huanti_leaves / $inventory[$side_number].huanti_leaves / $inventory[$side_number].health_potion=<span color='{BOB_GREEN}'>" + _"Huanti Leaves + Huanti Leaves = Health Potion" + "</span>
<span size='small'>" + _"Restores 6 hitpoints" + "</span>"
		[show_if]
			{BOB_CONDITION inventory[$side_number].huanti_leaves greater_than_equal_to 2}
		[/show_if]
		[command]
			{VARIABLE_OP inventory[$side_number].huanti_leaves add -2}
			{VARIABLE_OP inventory[$side_number].health_potion add 1}
			{VARIABLE concocted_item _"a Health Potion"}
			{BOB_PRINT_G _"$character[$side_number].name has concocted $concocted_item|."
			      _"female^$character[$side_number].name has concocted $concocted_item|."}
		[/command]
	[/option]
	# Endurance Potion
	{BOB_CONCOCTION_OBJECT huanti_leaves ulox_rock endurance_potion
	_"Huanti Leaves + Ulox Rock = Endurance Potion" _"Restores 10 hitpoints and adds 1 max hitpoint" _"an Endurance Potion"}
	# Stamina Potion
	{BOB_CONCOCTION_OBJECT gold_nugget ulox_rock stamina_potion
	_"Gold Nugget + Ulox Rock = Stamina Potion" _"Adds 3 max hitpoints" _"a Stamina Potion"}
	# Life Potion
	{BOB_CONCOCTION_OBJECT huanti_leaves gold_nugget life_potion
	_"Huanti Leaves + Gold Nugget = Life Potion" _"Restores 20 hitpoints" _"a Life Potion"}
	# Brainhaste Tonic
	{BOB_CONCOCTION_OBJECT slime yoll_tree_bark brainhaste_tonic
	_"Slime + Yoll Tree Bark = Brainhaste Tonic" _"Adds 4 experience" _"a Brainhaste Tonic"}
	# Mind Juice
	{BOB_CONCOCTION_OBJECT gold_nugget yoll_tree_bark mind_juice
	_"Gold Nugget + Yoll Tree Bark = Mind Juice" _"-3 max experience" _"some Mind Juice"}
	# Antidote
	{BOB_CONCOCTION_OBJECT huanti_leaves scorpion_tail antidote
	_"Huanti Leaves + Scorpion Tail = Antidote" _"Cures poison" _"an Antidote"}
	# Speed Serum
	{BOB_CONCOCTION_OBJECT slime scorpion_tail speed_serum
	_"Slime + Scorpion Tail = Speed Serum" _"Restores moves but poisons your metabolism" _"some Speed Serum"}
	# Energy Cocktail
	{BOB_CONCOCTION_OBJECT slime gold_nugget energy_cocktail
	_"Slime + Gold Nugget = Energy Cocktail" _"Restores moves after next combat" _"an Energy Cocktail"}
	# Bloodlust Bile
	{BOB_CONCOCTION_OBJECT slime fang bloodlust_bile
	_"Slime + Fang = Bloodlust Bile" _"You can attack twice" _"some Bloodlust Bile"}
	# Frenzy Fluid
	{BOB_CONCOCTION_OBJECT gold_nugget fang frenzy_fluid
	_"Gold Nugget + Fang = Frenzy Fluid" _"Your next combat will last two rounds" _"some Frenzy Fluid"}

[/message]
[/do]
[/while]
{CLEAR_VARIABLE concocted_item}
[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Conjurer
####################################################################################

#define BOB_CONJURING_OBJECT RAW_ID UNIT_ID RAW_STRING UNIT_STRING
[option]
	message= "&inventory/materials/{RAW_ID}.png=$inventory[$side_number].{RAW_ID}=<span color='{BOB_GREEN}'>" + {RAW_STRING} + "</span>
<span size='small'>" + {UNIT_STRING} + "</span>"
	[show_if]
		{BOB_CONDITION inventory[$side_number].{RAW_ID} greater_than_equal_to 1}
	[/show_if]
	[command]
		{VARIABLE_OP inventory[$side_number].{RAW_ID} add -1}
		#{BOB_PRINT _"$character[$side_number].name has conjured a Mudcrawler"}
		{CLEAR_VARIABLE finished}
		{BOB_CREATE_CONJURED_UNIT {UNIT_ID}}
	[/command]
[/option]
#enddef

#define BOB_TALENT_CONJURER
[event]
	name=start

[set_menu_item]
	id=Conjure
	description=_ "menu^Conjure"
	image=misc/conjurer.png
	[show_if]
		#{BOB_CONDITION character[$side_number].talent equals conjurer}
		[not]
			[have_unit]
				x,y=$x1,$y1
			[/have_unit]
		[/not]
	[/show_if]
	[filter_location]
		[not]
			terrain="Xt,Xu,Xv,*^Xo,Xos,Qt,Qlf,Ql,Qxu,Md^Xm,Mm^Xm,Wo,_off^_usr"
		[/not]
		[and]
			[filter]
				side=$side_number
				canrecruit=yes
				[filter_wml]
					[modifications]
						[trait]
							id=conjurer
						[/trait]
					[/modifications]
					attacks_left=1
				[/filter_wml]
			[/filter]
			radius=1
		[/and]
	[/filter_location]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/conjurer.png
	caption=_ "Conjure"
	message=_ "Conjuring allows you to use raw materials from your inventory to create new units. Conjured units are not permanent: every turn there is a 30% chance the magic will wane and they will vanish."
	
	[option]
		message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
		[command]
			{CLEAR_VARIABLE finished}
		[/command]
	[/option]

	{BOB_CONJURING_OBJECT  clay            "Mudcrawler"          _"Use Clay"            _"Creates a Mudcrawler"}
	{BOB_CONJURING_OBJECT  slime           "BOB_Swampcrawler"    _"Use Slime"           _"Creates a Swampcrawler"}
	{BOB_CONJURING_OBJECT  fang            "Wolf"                _"Use Fang"            _"Creates a Wolf"}
	{BOB_CONJURING_OBJECT  lizard_tail     "Saurian Skirmisher"  _"Use Lizard Tail"     _"Creates a Saurian Skirmisher"}
	{BOB_CONJURING_OBJECT  skull           "Skeleton"            _"Use Skull"           _"Creates a Skeleton"}
	{BOB_CONJURING_OBJECT  scorpion_tail   "Giant Scorpion"      _"Use Scorpion Tail"   _"Creates a Giant Scorpion"}
	{BOB_CONJURING_OBJECT  yoll_tree_bark  "BOB_Wose Sapling"    _"Use Yoll Tree Bark"  _"Creates a Wose Sapling"}
	{BOB_CONJURING_OBJECT  dragon_tail     "Fire Dragon"         _"Use Dragon Tail"     _"Creates a Fire Dragon"}

[/message]
[/do]
[/while]
[/command]
[/set_menu_item]

[/event]

# Test if the creature vanishes

[event]
	name="side turn"
	first_time_only=no
	
	[store_unit]
		[filter]
			ability=conjured
			side=$side_number
		[/filter]
		variable=conjured
		kill=no
	[/store_unit]

	{FOREACH conjured i}
		{RANDOM 1..10}
		[if]
			{BOB_CONDITION random less_than_equal_to 3}
			[then]
				{VARIABLE temp_x $conjured[$i].x}
				{VARIABLE temp_y $conjured[$i].y}
				{SCROLL_TO $conjured[$i].x $conjured[$i].y}
				[unstore_unit]
					variable=conjured[$i]
				[/unstore_unit]
				{BOB_SOUND magic-missile-1-miss.ogg,magic-missile-2-miss.ogg,magic-missile-3-miss.ogg}
				[kill]
					x,y=$temp_x,$temp_y
					animate=yes
				[/kill]
			[/then]
		[/if]
		[if]
			{BOB_CONDITION random greater_than 3}
			[then]
				[unstore_unit]
					variable=conjured[$i]
				[/unstore_unit]
			[/then]
		[/if]
	{NEXT i}

	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE conjured}
	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
	
[/event]
#enddef

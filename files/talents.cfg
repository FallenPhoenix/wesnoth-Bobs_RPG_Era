
####################################################################################
# Talent Definitions
####################################################################################

#define TRAIT_WEAPONCRAFT
    [trait]
        id=weaponcraft
        male_name= _ "weaponcraft"
        female_name= _ "female^weaponcraft"
        description= _ "You've learned to take great care of your weapon, knowing that preparation is often decisive on the battlefield. Weaponcraft allows you to use raw materials from your inventory to improve your melee weapon. This is done by right-clicking on your character."
    [/trait]
#enddef

#define TRAIT_ROUSER
    [trait]
        id=rouser
        male_name= _ "rouser"
        female_name= _ "female^rouser"
        description= _ "With fine words and a steely resolve you are able to rouse your allies into performing deeds of bravery. A unit that has been roused begins their turn with two extra movement points. This is done by right-clicking on an adjacent friendly unit. It can only be done once a turn."
    [/trait]
#enddef

#define TRAIT_RIDER
    [trait]
        id=rider
        male_name= _ "rider"
        female_name= _ "female^rider"
        description= _ "You are trained in the art of riding. Any animal with the 'mount' ability can be mounted by a rider. This is done by right-clicking on an adjacent unit. To dismount, right-click again on an empty adjacent hex. Whilst mounted your max moves, movetype and pierce resistances are modified."
    [/trait]
#enddef

#define TRAIT_HERBALISM
    [trait]
        id=herbalism
        male_name= _ "herbalism"
        female_name= _ "female^herbalism"
        description= _ "You have a thorough knowledge of plants and their medicinal properties. Herbalism allows you to use raw materials from your inventory to apply medicinal balms. This is done by right-clicking on your character."
    [/trait]
#enddef

#define TRAIT_TAMER
    [trait]
        id=tamer
        male_name= _ "tamer"
        female_name= _ "female^tamer"
        description= _ "You have a natural affinity with beasts of the wild. Each turn, instead of attacking, a tamer can attempt to tame a creature or monster. This is done by right-clicking on a suitable adjacent unit. A taming attempt has a 60% of success. If the attempt fails the creature will lash out; if it is successful, the creature will join the side of the tamer. However, every subsequent turn there is a 30% chance that the creature will become wild again."
    [/trait]
#enddef

#define TRAIT_PICKPOCKET
    [trait]
        id=pickpocket
        male_name= _ "pickpocket"
        female_name= _ "female^pickpocket"
        description= _ "Your fingers have a habit of slipping into other people's purses. Each turn, instead of attacking, a pickpocket can attempt to steal gold from a unit (but only those likely to carry some). This is done by right-clicking on a suitable adjacent unit. A pickpocket attempt has a 60% of success. If the attempt fails the unit will notice and strike out; if it is successful, the pickpocket earns a small random sum of gold. You can only ever try to pickpocket a unit once, even if the attempt fails. Richer pickings can be found in the pockets of higher level units."
    [/trait]
#enddef

#define TRAIT_TRAPPER
    [trait]
        id=trapper
        male_name= _ "trapper"
        female_name= _ "female^trapper"
        description= _ "You are skilled at ensnaring both man and beast alike. A trapper can use raw materials from their inventory to create traps. This is done by right-clicking on your character. To set a trap you must right-click on an empty non-water adjacent hex. Traps remain on the map until a unit sets it off or a trapper picks it up."
    [/trait]
#enddef

#define TRAIT_CONCOCTION
    [trait]
        id=concoction
        male_name= _ "concoction"
        female_name= _ "female^concoction"
        description= _ "You have mastered the art of fusing the elements into potent fluids. Concoction allows you to use raw materials from your inventory to create potions. This is done by right-clicking on your character."
    [/trait]
#enddef

#define TRAIT_CONJURER
    [trait]
        id=conjurer
        male_name= _ "conjurer"
        female_name= _ "female^conjurer"
        description= _ "You have the power to conjure creatures out of the ether. Conjuring allows you to use raw materials from your inventory to create new units. This is done by right-clicking on an empty non-water adjacent hex. Every turn there is a 30% chance the magic will wane and the conjured creature will vanish."
    [/trait]
#enddef

#define TRAIT_CASTING
    [trait]
        id=casting
        male_name= _ "casting"
        female_name= _ "female^casting"
        description= _ "You have learned to harness the flux of magic and bind it to your will. Casting allows you to use magic scrolls. This is done by right-clicking on the target of the spell."
    [/trait]
#enddef

####################################################################################
# Talent Menu
####################################################################################

#define BOB_CHOOSE_TALENT

[message]
	image=wesnoth-icon.png
	speaker=narrator
	caption=_ "Character Design"
	message= _ "Choose a talent for your character."

#####################
# Warrior
#####################

# Weaponcraft

[option]
message= "&icons/traits/weaponcraft.png=<span color='{BOB_GREEN}'>" + _"Weaponcraft" + "</span>
<span size='small'>" + _"You are skilled at preparing and maintaining your weapon.
Effect: Allows you to use raw materials to improve melee weapons." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].warrior_level_number greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent weaponcraft}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_WEAPONCRAFT}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY scorpion_tail ulox_rock}
[/command]
[/option]

# Rouser

[option]
message= "&icons/traits/rouser.png=<span color='{BOB_GREEN}'>"+ _"Rouser" + "</span>
<span size='small'>" + _"You are able to rouse allies into performing deeds of bravery.
Effect: Allows you to give others a temporary movement bonus." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].warrior_level_number greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent rouser}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_ROUSER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY energy_cocktail speed_serum}
	{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.variables.has_roused no})}
[/command]
[/option]

# Rider
[option]
message= "&icons/traits/rider.png=<span color='{BOB_GREEN}'>" + _"Rider" + "</span>
<span size='small'>" + _"You are trained in the art of riding.
Effect: Allows you to mount and ride horses." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].warrior_level_number greater_than_equal_to 1}
	{BOB_CONDITION unit.type equals "Human Lieutenant"}
	# Disable the option
	{BOB_CONDITION unit.type equals "Disable This Option"}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent rider}
{BOB_RANDOM_INVENTORY energy_cocktail speed_serum}
{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.variables.moves_before_mounting $stored_unit.max_moves})}
[object]
	silent=yes
	duration=forever
	[filter]
		side=$side_number
		canrecruit=yes
	[/filter]
	[effect]
		apply_to=variation
		name=Mounted
	[/effect]
[/object]
{BOB_REDRAW}
[/command]
[/option]

#####################
# Ranger
#####################

# Herbalism

[option]
message= "&icons/traits/herbalism.png=<span color='{BOB_GREEN}'>" + _"Herbalism" + "</span>
<span size='small'>" + _"You have a thorough knowledge of plants and their medicinal properties.
Effect: Allows you to use raw materials to create simple balms." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].ranger_level_number greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE character[$side_number].talent herbalism}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_HERBALISM}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY antidote huanti_leaves}
[/command]
[/option]

# Tamer

[option]
message= "&icons/traits/tamer.png=<span color='{BOB_GREEN}'>" + _"Tamer" + "</span>
<span size='small'>" + _"You have a natural affinity with beasts of the wild.
Effect: Allows you to temporarily tame creatures." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].ranger_level_number greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent tamer}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_TAMER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY scorpion_tail fang}
[/command]
[/option]

#####################
# Vagabond
#####################

# Trapper

[option]
message= "&icons/traits/trapper.png=<span color='{BOB_GREEN}'>" + _"Trapper" + "</span>
<span size='small'>" + _"You are skilled at ensnaring both man and beast alike.
Effect: Allows you to make and set traps." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].vagabond_level_number greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent trapper}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_TRAPPER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY poison net}
[/command]
[/option]

# Pickpocket

[option]
message= "&icons/traits/pickpocket.png=<span color='{BOB_GREEN}'>" + _"Pickpocket" + "</span>
<span size='small'>" + _"Your fingers have a habit of slipping into other people's purses.
Effect: Allows you to steal gold from other units." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].vagabond_level_number greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent pickpocket}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_PICKPOCKET}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY gold_nugget fang}
[/command]
[/option]

#####################
# Magician
#####################

# Concoction

[option]
message= "&icons/traits/concoction.png=<span color='{BOB_GREEN}'>" + _"Concoction" + "</span>
<span size='small'>" + _"You have mastered the art of fusing the elements into potent fluids.
Effect: Allows you to mix raw materials to create potions." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].magician_level_number greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent concoction}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_CONCOCTION}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY endurance_potion mind_juice}
[/command]
[/option]

# Conjurer

[option]
message= "&icons/traits/conjurer.png=<span color='{BOB_GREEN}'>" + _"Conjurer" + "</span>
<span size='small'>" + _"You have the power to conjure creatures out of the ether.
Effect: Allows you use raw materials to create new units." + "</span>"
[show_if]
	{BOB_CONDITION character[$side_number].magician_level_number greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE character[$side_number].talent conjurer}
	[modify_unit]
		[filter]
			x,y=$x1,$y1
		[/filter]
		[modifications]
			{TRAIT_CONJURER}
		[/modifications]
	[/modify_unit]
	{BOB_RANDOM_INVENTORY skull clay}
[/command]
[/option]

# Casting

#[option]
#message= {MENU_IMG_TXT "icons/traits/casting.png" _"<span color='{BOB_GREEN}'>Casting</span>
#<span size='small'>You have learned to harness the flux of magic and bind it to your will.
#Effect: Allows you to cast spells.</span>"}
#[show_if]
#	{BOB_CONDITION character[$side_number].magician_level_number greater_than_equal_to 1}
#	[/show_if]
#[command]
#{VARIABLE character[$side_number].talent casting}
#{BOB_RANDOM_INVENTORY energy_cocktail speed_serum}
#[/command]
#[/option]

[/message]
#enddef


####################################################################################
# Weaponcraft
####################################################################################

#define BOB_TALENT_WEAPONCRAFT
[event]
	name=start
	
[set_menu_item]
	id=Weaponcraft
	description=_ "menu^Use Weaponcraft"
	image=misc/weaponcraft.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals weaponcraft}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[not]
				[filter_wml]
					moves=0
				[/filter_wml] 
			[/not]
		[/have_unit]
	[/show_if]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/weaponcraft.png
	caption=_ "Weaponcraft"
	message=_ "Weaponcraft allows you to use raw materials from your inventory to improve your melee weapon. The effects of weaponcraft are temporary and will wear off after your next combat - or if you equip a new weapon."

[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
{VARIABLE finished yes}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/ulox_rock.png" "$inventory[$side_number].ulox_rock" _"<span color='{BOB_GREEN}'>Sharpen With Ulox Rock</span>
<span size='small'>+1 to melee damage</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 1}
	{BOB_CONDITION character[$side_number].melee_weapon_temp_damage_bonus less_than 1}
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].ulox_rock add -1}
	{BOB_ADD_WEAPON_SPECIAL melee $character[$side_number].melee_weapon_name TEMP_SHARPENED}
	{BOB_MODIFY_WEAPON melee damage 1 $character[$side_number].melee_weapon_name}
	{VARIABLE_OP character[$side_number].melee_weapon_temp_damage_bonus add 1}
	{BOB_PRINT ("$character[$side_number].name has used Weaponcraft")}
[/command]
[/option]

# If the weapon is already 'sharpened', this prevents the special being applied multiple times
[option]
message= {MENU_IMG_TXT2 "inventory/materials/ulox_rock.png" "$inventory[$side_number].ulox_rock" _"<span color='{BOB_GREEN}'>Sharpen With Ulox Rock</span>
<span size='small'>+1 to melee damage</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 1}
	{BOB_CONDITION character[$side_number].melee_weapon_temp_damage_bonus greater_than_equal_to 1}
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].ulox_rock add -1}
	{BOB_MODIFY_WEAPON melee damage 1 $character[$side_number].melee_weapon_name}
	{VARIABLE_OP character[$side_number].melee_weapon_temp_damage_bonus add 1}
	{BOB_PRINT ("$character[$side_number].name has used Weaponcraft")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/slime.png" "$inventory[$side_number].slime" _"<span color='{BOB_GREEN}'>Smear With Slime</span>
<span size='small'>Gives your melee weapon the slows special</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
	[have_unit]
		x,y=$x1,$y1
		[not]
		[filter_wml]
			[attack]
				[specials]
					[slow]
						id=temp_slow
					[/slow]
				[/specials]
			[/attack]
		[/filter_wml]
		[/not]
	[/have_unit]
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].slime add -1}
	{BOB_ADD_WEAPON_SPECIAL melee $character[$side_number].melee_weapon_name TEMP_SLOW}
	{BOB_PRINT ("$character[$side_number].name has used Weaponcraft")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/scorpion_tail.png" "$inventory[$side_number].scorpion_tail" _"<span color='{BOB_GREEN}'>Rub With Scorpion Tail</span>
<span size='small'>Makes your melee weapon poisonous</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
	[have_unit]
		x,y=$x1,$y1
		[not]
		[filter_wml]
			[attack]
				[specials]
					[poison]
						id=temp_poison
					[/poison]
				[/specials]
			[/attack]
		[/filter_wml]
		[/not]
	[/have_unit]
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].scorpion_tail add -1}
	{BOB_ADD_WEAPON_SPECIAL melee $character[$side_number].melee_weapon_name TEMP_POISON}
	{BOB_PRINT ("$character[$side_number].name has used Weaponcraft")}
[/command]
[/option]

[/message]
[/do]
[/while]
[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Rouser
####################################################################################

#define BOB_TALENT_ROUSER	
[event]
	name=start
	
[set_menu_item]
	id=Rouse
	description=_ "menu^Rouse"
	image=misc/rouser.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals rouser}
		[have_unit]
			x,y=$x1,$y1
			is_enemy=no
			[not]
				ability=temp_roused
			[/not]
			[not]
				side=$side_number
				canrecruit=yes
			[/not]
		[/have_unit]
	[/show_if]
	[filter_location]
		[filter]
			side=$side_number
			canrecruit=yes
			[not]
				[filter_wml]
					[variables]
						has_roused=yes
					[/variables]
				[/filter_wml]
			[/not]
			[not]
				[filter_wml]
					attacks_left=0
					#moves=0
				[/filter_wml]
			[/not]
		[/filter]
		radius=1
	[/filter_location]
	[command]
		{BOB_MODIFY_MOVEMENT x=$x1 y=$y1 2}
		{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE_OP stored_unit.moves add 2})}
		{BOB_ADD_ABILITY ROUSED}
		{BOB_FLOATER x=$x1 y=$y1 (Roused) green}
		{BOB_STORE_UNIT canrecruit=yes side=$side_number ({VARIABLE stored_unit.variables.has_roused yes})}
	[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Rider
####################################################################################

#define BOB_TALENT_RIDER
[event]
	name=start
	
# Dismount

[set_menu_item]
	id=Dismount
	description=_ "menu^Dismount"
	image=misc/feet.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals rider}
		[not]
			[have_unit]
				x,y=$x1,$y1
			[/have_unit]
		[/not]
	[/show_if]
	[filter_location]
		[not]
			terrain="Xt,Xu,Xv,*^Xo,Xos,Qt,Qlf,Ql,Qxu,Md^Xm,Mm^Xm,Wo,_off^_usr"
		[/not]
		[and]
			[filter]
				side=$side_number
				canrecruit=yes
				[filter_wml]
					variation=Mounted
					[variables]
						[not]
							moves_before_mounting=0
						[/not]
					[/variables]
				[/filter_wml]
				#[not]
				#	[filter_wml]
				#		moves=0
				#	[/filter_wml] 
				#[/not]
			[/filter]
			radius=1
		[/and]
	[/filter_location]
[command]
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
	{VARIABLE temp_x $stored_unit.x}
	{VARIABLE temp_y $stored_unit.y}
	{VARIABLE temp_moves $stored_unit.moves}
	{VARIABLE temp_name $stored_unit.variables.mount_name}
	{VARIABLE stored_unit.attack[0].icon $character[$side_number].melee_weapon_icon}
	{VARIABLE stored_unit.attack[1].icon $character[$side_number].ranged_weapon_icon}
	{VARIABLE stored_unit.moves $stored_unit.variables.moves_before_mounting}
	{VARIABLE stored_unit.variables.moves_before_mounting 0}
	{VARIABLE_OP stored_unit.moves add -1}
	)}
	[object]
		silent=yes
		duration=forever
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[effect]
			apply_to=variation
			name="$none"
		[/effect]
	[/object]
	{BOB_TELEPORT side=$side_number canrecruit=yes $x1 $y1}
	{BOB_REDRAW}
	[unit]
		side=$side_number
		type=BOB_Horse
		random_traits=no
		name=$temp_name
		x=$temp_x
		y=$temp_y
		moves=$temp_moves
	[/unit]

	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
	{CLEAR_VARIABLE temp_moves}
	{CLEAR_VARIABLE temp_name}
[/command]
[/set_menu_item] 

# Mount

[set_menu_item]
	id=Mount
	description=_ "menu^Mount"
	image=misc/hand.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals rider}
		[have_unit]
			x,y=$x1,$y1
			ability=mount
		[/have_unit]
	[/show_if]
[filter_location]
  [filter]
	side=$side_number
    canrecruit=yes
    [not]
		[filter_wml]
			variation=Mounted
		[/filter_wml]
	[/not]
    [not]
		[filter_wml]
			moves=0
		[/filter_wml]
	[/not]
  [/filter]
  radius=1
[/filter_location]
[command]
	
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
	# Remember how many moves the character had left (-1 for mounting)
	{VARIABLE stored_unit.variables.moves_before_mounting $stored_unit.moves}
	{VARIABLE_OP stored_unit.variables.moves_before_mounting add -1}
	# Set character's moves to the horse's moves
	{VARIABLE stored_unit.moves $unit.moves}
	# Remember the horse's name
	{VARIABLE stored_unit.variables.mount_name $unit.name}
	# Show the character's icons
	{VARIABLE stored_unit.attack[0].icon $character[$side_number].melee_weapon_icon}
	{VARIABLE stored_unit.attack[1].icon $character[$side_number].ranged_weapon_icon}
	)}
	[object]
		silent=yes
		duration=forever
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[effect]
			apply_to=variation
			name=Mounted
		[/effect]
	[/object]
	[kill]
		x=$x1
		y=$y1
		animate=no
	[/kill]
	{BOB_TELEPORT side=$side_number canrecruit=yes $x1 $y1}
	{BOB_REDRAW}
[/command]
[/set_menu_item]
[/event]

[event]
	name="turn refresh"
	first_time_only=no
	[store_unit]
		[filter]
			side=$side_number
			canrecruit=yes
			[filter_wml]
				variation=Mounted
			[/filter_wml]
		[/filter]
		variable=unit
	[/store_unit]
		{VARIABLE unit.variables.moves_before_mounting $stored_unit.moves}
		{VARIABLE unit.variables.moves_before_mounting $stored_unit.moves}
	[unstore_unit]
		variable=units
	[/unstore_unit]
[/event]
#enddef

####################################################################################
# Herbalism
####################################################################################

#define BOB_TALENT_HERBALISM
[event]
	name=start
	
[set_menu_item]
	id=Herbalism
	description=_ "menu^Use Herbalism"
	image=misc/herbalism.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals herbalism}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[not]
				[filter_wml]
					moves=0
				[/filter_wml] 
			[/not]
		[/have_unit]
	[/show_if]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/herbalism.png
	caption=_ "Herbalism"
	message=_ "Herbalism allows you to use raw materials from your inventory to make medicinal balms and broths. The effects are instant."

[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
{VARIABLE finished yes}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/huanti_leaves.png" "$inventory[$side_number].huanti_leaves" _"<span color='{BOB_GREEN}'>Use Huanti Leaves</span>
<span size='small'>Restores 4 hitpoints</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].huanti_leaves greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent healing when at max hp	
	[if]
		[have_unit]
			x,y=$x1,$y1
			[not]
				[filter_wml]
					hitpoints=$this_unit.max_hitpoints
				[/filter_wml]
			[/not]
		[/have_unit]
		[then]
			{VARIABLE_OP inventory[$side_number].huanti_leaves add -1}
			{BOB_MODIFY_HITPOINTS 4 no 0}
			{BOB_PRINT ("$character[$side_number].name has used Herbalism")}
			{BOB_REDRAW}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/ulox_rock.png" "$inventory[$side_number].ulox_rock" _"<span color='{BOB_GREEN}'>Use Ulox Rocks</span>
<span size='small'>+1 max hitpoints (uses 2 rocks)</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 2}
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].ulox_rock add -2}
	{BOB_MODIFY_HITPOINTS 0 no 1}
	{BOB_PRINT ("$character[$side_number].name has used Herbalism")}
	{BOB_REDRAW}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/yoll_tree_bark.png" "$inventory[$side_number].yoll_tree_bark" _"<span color='{BOB_GREEN}'>Use Yoll Tree Bark</span>
<span size='small'>-1 max experience</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].yoll_tree_bark greater_than_equal_to 1}
[/show_if]
[command]
	{BOB_STORE ({VARIABLE temp_max_xp $stored.max_experience})}
	# Prevent making max xp too low
	[if]
		{BOB_CONDITION temp_max_xp greater_than_equal_to 11}
		[then]
			{VARIABLE_OP inventory[$side_number].yoll_tree_bark add -1}
			{BOB_MODIFY_EXPERIENCE -1}
			{BOB_PRINT ("$character[$side_number].name has used Herbalism")}
			{BOB_REDRAW}
		[/then]
	[/if]
	{CLEAR_VARIABLE temp_max_xp}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/scorpion_tail.png" "$inventory[$side_number].scorpion_tail" _"<span color='{BOB_GREEN}'>Use Scorpion Tail</span>
<span size='small'>Cures poison</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent curing when not poisoned
	[if]
		[have_unit]
			x,y=$x1,$y1
			[filter_wml]
				[status]
					poisoned=yes
				[/status]
			[/filter_wml]
		[/have_unit]
		[then]
			{VARIABLE_OP inventory[$side_number].scorpion_tail add -1}
			{BOB_ALTER_STATUS x=$x1 y=$y1 poisoned no}
			{BOB_PRINT ("$character[$side_number].name has used Herbalism")}
			{BOB_REDRAW}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/slime.png" "$inventory[$side_number].slime" _"<span color='{BOB_GREEN}'>Use Slime</span>
<span size='small'>Removes slow</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent unslowing when not slowed
	[if]
		[have_unit]
			x,y=$x1,$y1
			[filter_wml]
				[status]
					slowed=yes
				[/status]
			[/filter_wml]
		[/have_unit]
		[then]
			{VARIABLE_OP inventory[$side_number].slime add -1}
			{BOB_ALTER_STATUS x=$x1 y=$y1 slowed no}
			{BOB_PRINT ("$character[$side_number].name has used Herbalism")}
			{BOB_REDRAW}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/fang.png" "$inventory[$side_number].fang" _"<span color='{BOB_GREEN}'>Use Fang</span>
<span size='small'>Restores moves</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].fang greater_than_equal_to 1}
[/show_if]
[command]
	# Prevent restoring moves when at max moves
	[if]
		[have_unit]
			x,y=$x1,$y1
			[not]
				[filter_wml]
					moves=$this_unit.max_moves
				[/filter_wml]
			[/not]
		[/have_unit]
		[then]
			{VARIABLE_OP inventory[$side_number].fang add -1}
			{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.moves $stored_unit.max_moves})}
			{BOB_MODIFY_EXPERIENCE 0}
			{BOB_PRINT ("$character[$side_number].name has used Herbalism")}
			{BOB_REDRAW}
		[/then]
	[/if]
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "inventory/materials/dragon_tail.png" "$inventory[$side_number].dragon_tail" _"<span color='{BOB_GREEN}'>Use Dragon Tail</span>
<span size='small'>+20% resistance to fire damage</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].dragon_tail greater_than_equal_to 1}
[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].dragon_tail add -1}
	{BOB_MODIFY_RESISTANCE x=$x1 y=$y1 fire -20}
	{BOB_PRINT ("$character[$side_number].name has used Herbalism")}
	{BOB_REDRAW}
[/command]
[/option]

[/message]
[/do]
[/while]
[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Tamer
####################################################################################

#define BOB_TALENT_TAMER
[event]
	name=start
[set_menu_item]
	id=Tame
	description=_ "menu^Tame"
	image=misc/hand.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals tamer}
		[have_unit]
			x,y=$x1,$y1
			[not]
				side=$side_number
			[/not]
			[not]
				ability=tamed
			[/not]
			[and]
				race=monster
				[or]
					race=bats
				[/or]
				[or]
					type=Wolf
				[/or]
				[or]
					type=Gryphon
				[/or]
				[or]
					race=animal
				[/or]
			[/and]
		[/have_unit]
	[/show_if]
	[filter_location]
		[filter]
			side=$side_number
			canrecruit=yes
			[not]
				[filter_wml]
					attacks_left=0
				[/filter_wml]
			[/not]
		[/filter]
		radius=1
	[/filter_location]
[command]
	
	# Get the variables of tamer
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
	{VARIABLE temp_x $stored_unit.x}
	{VARIABLE temp_y $stored_unit.y}
	{VARIABLE temp_type $stored_unit.type}
	{VARIABLE stored_unit.attacks_left 0}
	)}
	
	# Simulate a taming animation
	
    [animate_unit]
		flag=attack
		with_bars=no
		hits=yes
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[primary_attack]
			range=melee
		[/primary_attack]
		[facing]
			x,y=$x1,$y1
		[/facing]
	[/animate_unit]
	
	{BOB_DELAY 200}
	
	# 60% chance of successfully taming the creature
	{RANDOM 1..10}
	[if]
		{BOB_CONDITION random less_than_equal_to 6}
		[then]
			{BOB_ADD_ABILITY TAMED}
			[store_unit]
				[filter]
					x,y=$x1,$y1
				[/filter]
				variable=stored_unit
			[/store_unit]
				{VARIABLE stored_unit.variables.original_side $stored_unit.side}
				
				{VARIABLE stored_unit.side $side_number}
				{VARIABLE stored_unit.moves $stored_unit.max_moves}
				{VARIABLE stored_unit.attacks_left 1}
				{VARIABLE stored_unit.upkeep 0}
				{BOB_SOUND bite-small.ogg}	
			[unstore_unit]
				variable=stored_unit
				text= _ "Tamed"
				{COLOR_HEAL}
			[/unstore_unit]
   			{BOB_DELAY 100}
		[/then]
	[/if]
		
		
	# 40% chance of being attacked by creature
	[if]
		{BOB_CONDITION random greater_than 6}
		[then]
			# Calculate the damage
			[store_unit]
				[filter]
					side=$side_number
					canrecruit=yes
				[/filter]
				variable=stored_unit
			[/store_unit]
				{VARIABLE temp_damage $unit.attack[0].damage}
				{VARIABLE_OP temp_damage multiply $stored_unit.resistance.$unit.attack[0].type}
				{VARIABLE_OP temp_damage divide 100}
				{VARIABLE_OP stored_unit.hitpoints add -$temp_damage}
				
				# Simulate an attack animation
				[animate_unit]
					flag=attack
					with_bars=yes
					hits=yes
					[filter]
						x=$x1
						y=$y1
					[/filter]
					[primary_attack]
						range=melee
					[/primary_attack]
					[facing]
						x,y=$temp_x,$temp_y
					[/facing]
				[/animate_unit]
			
				{BOB_SOUND {SOUND_LIST:HUMAN_HIT}}
			[unstore_unit]
				variable=stored_unit
				text="$temp_damage"
				{COLOR_HARM}
			[/unstore_unit]
		[/then]
	[/if]		
	
	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
	{CLEAR_VARIABLE temp_damage}
	{CLEAR_VARIABLE temp_type}
	
	[/command]
	[/set_menu_item]
[/event]

# Test if the animal reverts to the wild

[event]
    name="side turn"
    first_time_only=no
   
	[store_unit]
		[filter]
			ability=tamed
			side=$side_number
		[/filter]
		variable=beasts
		kill=no
	[/store_unit]

	{FOREACH beasts i}
		   
		{RANDOM 1..10}
	   
		[if]
			{BOB_CONDITION random less_than_equal_to 3}
			[then]
				{SCROLL_TO $beasts[$i].x $beasts[$i].y}
				{BOB_SOUND bite-small.ogg}
				{VARIABLE beasts[$i].side $beasts[$i].variables.original_side}
				{VARIABLE beasts[$i].moves $beasts[$i].max_moves}
				{VARIABLE beasts[$i].attacks_left 1}
				{VARIABLE beasts[$i].upkeep $beasts[$i].level}
				[unstore_unit]
					variable=beasts[$i]
					text=_ "Wild"
					{COLOR_HARM}
				[/unstore_unit]
				{BOB_REMOVE_ABILITY TAMED}
			[/then]
		[/if]
		[if]
			{BOB_CONDITION random greater_than 3}
			[then]
				[unstore_unit]
					variable=beasts[$i]
				[/unstore_unit]
			[/then]
		[/if]
	{NEXT i}

	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE beasts}
   
[/event]
#enddef

####################################################################################
# Pickpocket
####################################################################################

#define BOB_TALENT_PICKPOCKET
[event]
	name=start
[set_menu_item]
	id=Pickpocket
	description=_ "menu^Pickpocket"
	image=misc/hand.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals pickpocket}
		[have_unit]
			x,y=$x1,$y1
			[not]
				side=$side_number
				canrecruit=yes
			[/not]
			[not]
				[filter_wml]
					[variables]
						pickpocketed=yes
					[/variables]
				[/filter_wml]
			[/not]
			[and]
				race=human
				[or]
					race=elf
				[/or]
				[or]
					race=dwarf
				[/or]
				[or]
					race=orc
				[/or]
				[or]
					race=goblin
				[/or]
				[or]
					race=drake
				[/or]
				[or]
					race=lizard
				[/or]
				[or]
					race=ogre
				[/or]
				[or]
					race=troll
				[/or]
				[or]
					race="dark elf"
				[/or]
				[or]
					race=kalifa
				[/or]
				[or]
					race=vampire
				[/or]
				[or]
					race=sidhe
				[/or]
				[or]
					race=aragwaith
				[/or]
				[or]
					race=calydonianrace
				[/or]
				[or]
					race=lavinian
				[/or]
				[or]
					race=nemidian
				[/or]
			[/and]
		[/have_unit]
	[/show_if]
	[filter_location]
		[filter]
			side=$side_number
			canrecruit=yes
			[not]
				[filter_wml]
					attacks_left=0
				[/filter_wml]
			[/not]
		[/filter]
		radius=1
	[/filter_location]
[command]
	
	# Get the variables of pickpocketer
	{BOB_STORE_UNIT side=$side_number canrecruit=yes (
	{VARIABLE temp_x $stored_unit.x}
	{VARIABLE temp_y $stored_unit.y}
	{VARIABLE temp_type $stored_unit.type}
	{VARIABLE stored_unit.attacks_left 0}
	)}
	
	# Simulate a theft animation
	
	[animate_unit]
		flag=attack
		with_bars=no
		hits=yes
		[filter]
			side=$side_number
			canrecruit=yes
		[/filter]
		[primary_attack]
			range=melee
		[/primary_attack]
		[facing]
			x,y=$x1,$y1
		[/facing]
	[/animate_unit]
	
	{BOB_DELAY 200}
	
	# 60% chance of successful pickpocket
	{RANDOM 1..10}
	[if]
		{BOB_CONDITION random less_than_equal_to 6}
		[then]
			# Calculate how much gold is stolen
			# (lvl 0: 1-3g)  (lvl 1: 2-6g)  (lvl 2: 3-9g)  (lvl 3: 4-12g)  (lvl 4: 5-15g)
			{RANDOM 1..3}
			{VARIABLE temp_gold $unit.level}
			{VARIABLE_OP temp_gold add 1}
			{VARIABLE_OP temp_gold multiply $random}
			
			# If the unit being pickpocketed is a leader...
			[if]
				[have_unit]
					x,y=$x1,$y1
					canrecruit=yes
				[/have_unit]
				[then]
					[store_side]
						side=$unit.side
						variable=victim
					[/store_side]
					# If the leader is broke, no gold can be stolen
					[if]
						{BOB_CONDITION victim.gold less_than_equal_to 0}
						[then]
							{BOB_PRINT ("$character[$side_number].name tried to pickpocket $unit.name|, but their pockets were empty.")}
						[/then]
					[/if]
					# If the leader has less gold than is about to be stolen, adjust the amount
					[if]
						{BOB_CONDITION victim.gold less_than $temp_gold}
						{BOB_CONDITION victim.gold greater_than 0}
						[then]
							{VARIABLE temp_gold $victim.gold}
							{BOB_GOLD $side_number $temp_gold}
							{BOB_GOLD $unit.side -$temp_gold}
							{BOB_SOUND gold.ogg}
							{BOB_FLOATING_LABEL side=$side_number canrecruit=yes "$temp_gold|g" {BOB_COLOR_GOLD}}
							{BOB_DELAY 100}
						[/then]
					[/if]
					# If the leader has enough gold
					[if]
						{BOB_CONDITION victim.gold greater_than_equal_to $temp_gold}
						[then]
							{BOB_GOLD $side_number $temp_gold}
							{BOB_GOLD $unit.side -$temp_gold}
							{BOB_SOUND gold.ogg}
							{BOB_FLOATING_LABEL side=$side_number canrecruit=yes "$temp_gold|g" {BOB_COLOR_GOLD}}
							{BOB_DELAY 100}
						[/then]
					[/if]
				[/then]
			[/if]
			# If the unit being pickpocketed is not a leader...
			[if]
				[have_unit]
					x,y=$x1,$y1
					canrecruit=no
				[/have_unit]
				[then]
					{BOB_GOLD $side_number $temp_gold}
					{BOB_SOUND gold.ogg}
					{BOB_FLOATING_LABEL side=$side_number canrecruit=yes "$temp_gold|g" {BOB_COLOR_GOLD}}
					{BOB_DELAY 100}
				[/then]
			[/if]
		
		[/then]
	[/if]
	
		
	# 40% chance of being noticed, and attacked
	[if]
		{BOB_CONDITION random greater_than 6}
		[then]
			# Random Angry Message
			[switch]
				variable=random
				[case]
					value=7
					[message]
						speaker=unit
						message=_ "Thief!"
					[/message]
				[/case]
				[case]
					value=8
					[message]
						speaker=unit
						message=_ "Don't try that again, you scoundrel!"
					[/message]
				[/case]
				[case]
					value=9
					[message]
						speaker=unit
						message=_ "Off with your fingers!"
					[/message]
				[/case]
				[case]
					value=10
					[message]
						speaker=unit
						message=_ "Be off with you, dirty pickpocket!"
					[/message]
				[/case]
			[/switch]
			
			# Calculate damage
			[store_unit]
				[filter]
					side=$side_number
					canrecruit=yes
				[/filter]
				variable=stored_unit
			[/store_unit]
				{VARIABLE temp_damage $unit.attack[0].damage}
				{VARIABLE_OP temp_damage multiply $stored_unit.resistance.$unit.attack[0].type}
				{VARIABLE_OP temp_damage divide 100}
				{VARIABLE_OP stored_unit.hitpoints add -$temp_damage}
				
				# Simulate an attack animation
				[animate_unit]
					flag=attack
					with_bars=yes
					hits=yes
					[filter]
						x=$x1
						y=$y1
					[/filter]
					[primary_attack]
						range=melee
					[/primary_attack]
					[facing]
						x,y=$temp_x,$temp_y
					[/facing]
				[/animate_unit]
				
				{BOB_SOUND {SOUND_LIST:HUMAN_HIT}}
			[unstore_unit]
				variable=stored_unit
				text="$temp_damage"
				{COLOR_HARM}
			[/unstore_unit]
		[/then]
	[/if]		
	
	# Ensure the unit cannot be pickpocketed again
	{BOB_STORE_UNIT x=$x1 y=$y1 ({VARIABLE stored_unit.variables.pickpocketed yes})}
					
	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE temp_gold}
	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
	{CLEAR_VARIABLE temp_damage}
	{CLEAR_VARIABLE temp_type}
	
	[/command]
	[/set_menu_item]
[/event]
#enddef

####################################################################################
# Trapper
####################################################################################

#define BOB_TALENT_TRAPPER
[event]
	name=start

# Make Trap
	
[set_menu_item]
	id=Make_Trap
	description=_ "menu^Make Trap"
	image=misc/trapper.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals trapper}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[not]
				[filter_wml]
					moves=0
				[/filter_wml] 
			[/not]
		[/have_unit]
	[/show_if]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/trapper.png
	caption=_ "Make Trap"
	message=_ "Trapper allows you to use raw materials from your inventory to construct traps. Any traps you make will be added to your inventory. To set a trap you must right-click on an empty adjacent hex."

[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
{VARIABLE finished yes}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/bomb_recipe.png" "$inventory[$side_number].ulox_rock / $inventory[$side_number].bomb" _"<span color='{BOB_GREEN}'>Use Ulox Rock</span>
<span size='small'>Creates Bomb Trap</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].bomb add 1}
{VARIABLE_OP inventory[$side_number].ulox_rock add -1}
{BOB_PRINT ("$character[$side_number].name has made a bomb trap")}
{BOB_REDRAW}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/poison_recipe.png" "$inventory[$side_number].scorpion_tail / $inventory[$side_number].poison" _"<span color='{BOB_GREEN}'>Use Scorpion Tail</span>
<span size='small'>Creates Poison Trap</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].poison add 1}
{VARIABLE_OP inventory[$side_number].scorpion_tail add -1}
{BOB_PRINT ("$character[$side_number].name has made a poison trap")}
{BOB_REDRAW}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/net_recipe.png" "$inventory[$side_number].yoll_tree_bark / $inventory[$side_number].net" _"<span color='{BOB_GREEN}'>Use Yoll Tree Bark</span>
<span size='small'>Creates Net Trap</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].yoll_tree_bark greater_than_equal_to 1}
	[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].net add 1}
{VARIABLE_OP inventory[$side_number].yoll_tree_bark add -1}
{BOB_PRINT ("$character[$side_number].name has made a net trap")}
{BOB_REDRAW}
[/command]
[/option]


[/message]
[/do]
[/while]
[/command]
[/set_menu_item]

# Set Trap

[set_menu_item]
	id=Set_Trap
	description=_ "menu^Set Trap"
	image=misc/trapper.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals trapper}
		[not]
			[have_unit]
				x,y=$x1,$y1
			[/have_unit]
		[/not]
	[/show_if]
	[filter_location]
		[not]
			terrain="Xt,Xu,Xv,*^Xo,Xos,Qt,Qlf,Ql,Qxu,Md^Xm,Mm^Xm,Wo,Ww,_off^_usr"
		[/not]
		[and]
			[filter]
				side=$side_number
				canrecruit=yes
			[/filter]
			radius=1
		[/and]
	[/filter_location]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/trapper.png
	caption=_ "Set Trap"
	message=_ "Trapper allows you to set traps on the ground. Traps remain in play unless they are triggered or a trapper picks them up. You cannot set more than one of the same trap on a hex. Remember, all units are affected by traps - even friendly ones."


[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
{VARIABLE finished yes}
[/command]
[/option]

# Bomb

[option]
message= {MENU_IMG_TXT2 "inventory/misc_items/bomb.png" "$inventory[$side_number].bomb" _"<span color='{BOB_GREEN}'>Bomb</span>
<span size='small'>A trap that does 12 hitpoints of damage when stepped on</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].bomb greater_than_equal_to 1}
	[have_location]
		x,y=$x1,$y1
		[not]
			find_in=bomb_xy
		[/not]
	[/have_location]
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].bomb add -1}
{PLACE_IMAGE items/bomb.png $x1 $y1}
[store_locations]
  variable=bomb_xy
  find_in=bomb_xy
  [or]
   x,y=$x1,$y1
  [/or]
 [/store_locations]
{BOB_PRINT ("$character[$side_number].name has set a bomb trap")}
{VARIABLE finished yes}
[/command]
[/option]

# Poison

[option]
message= {MENU_IMG_TXT2 "inventory/misc_items/poison.png" "$inventory[$side_number].poison" _"<span color='{BOB_GREEN}'>Poison</span>
<span size='small'>A trap that poisons when stepped on</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].poison greater_than_equal_to 1}
	[have_location]
		x,y=$x1,$y1
		[not]
			find_in=poison_xy
		[/not]
	[/have_location]
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].poison add -1}
{PLACE_IMAGE items/potion-poison.png $x1 $y1}
 [store_locations]
  variable=poison_xy
  find_in=poison_xy
  [or]
   x,y=$x1,$y1
  [/or]
 [/store_locations]
{BOB_PRINT ("$character[$side_number].name has set a poison trap")}
{VARIABLE finished yes}
[/command]
[/option]

# Net

[option]
message= {MENU_IMG_TXT2 "attacks/net.png" "$inventory[$side_number].net" _"<span color='{BOB_GREEN}'>Net</span>
<span size='small'>A trap that slows when stepped on</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].net greater_than_equal_to 1}
	[have_location]
		x,y=$x1,$y1
		[not]
			find_in=net_xy
		[/not]
	[/have_location]
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].net add -1}
{PLACE_IMAGE items/net.png $x1 $y1}
[store_locations]
  variable=net_xy
  find_in=net_xy
  [or]
   x,y=$x1,$y1
  [/or]
 [/store_locations]
{BOB_PRINT ("$character[$side_number].name has set a net trap")}
{VARIABLE finished yes}
[/command]
[/option]

[/message]
[/do]
[/while]
[/command]
[/set_menu_item]

[/event]

#####################
# Triggering Traps
#####################

# Poison Trap

[event]
name=moveto
first_time_only=no
	[filter]
		canrecruit=yes
		[filter_location]
			find_in=poison_xy
		[/filter_location]
		[filter_wml]
			[modifications]
				[trait]
					id=trapper
				[/trait]
			[/modifications]
		[/filter_wml]
	[/filter]
	{BOB_PRINT ("$character[$side_number].name has picked up a poison trap")}
	{BOB_SOUND skeleton-hit-2.ogg}
	{VARIABLE_OP inventory[$side_number].poison add 1}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=poison_xy
		find_in=poison_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]

[event]
name=moveto
first_time_only=no
	[filter]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=undead
					[/trait]
				[/modifications]
			[/filter_wml]
			[or]
				[filter_wml]
					[modifications]
						[trait]
							id=mechanical
						[/trait]
					[/modifications]
				[/filter_wml]
			[/or]
		[/not]
		[filter_location]
			find_in=poison_xy
		[/filter_location]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=trapper
					[/trait]
				[/modifications]
			[/filter_wml]
		[/not]
	[/filter]
	{BOB_ALTER_STATUS x=$x1 y=$y1 poisoned yes}
	{BOB_FLOATING_LABEL side=$side_number x,y=$x1,$y1 "Poisoned" {COLOR_HARM}}
	{BOB_SOUND poison.ogg}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=poison_xy
		find_in=poison_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]

# Bomb Trap

[event]
name=moveto
first_time_only=no
	[filter]
		canrecruit=yes
		[filter_location]
			find_in=bomb_xy
		[/filter_location]
		[filter_wml]
			[modifications]
				[trait]
					id=trapper
				[/trait]
			[/modifications]
		[/filter_wml]
	[/filter]
	{BOB_PRINT ("$character[$side_number].name has picked up a bomb trap")}
	{BOB_SOUND skeleton-hit-2.ogg}
	{VARIABLE_OP inventory[$side_number].bomb add 1}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=bomb_xy
		find_in=bomb_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]

[event]
name=moveto
first_time_only=no
	[filter]
		[filter_location]
			find_in=bomb_xy
		[/filter_location]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=trapper
					[/trait]
				[/modifications]
			[/filter_wml]
		[/not]
	[/filter]
	{BOB_SOUND explosion.ogg}
	[item]
		x,y=$x1,$y1
		halo="projectiles/fire-burst-small-1.png:75,projectiles/fire-burst-small-2.png:75,projectiles/fire-burst-small-3.png:75,projectiles/fire-burst-small-4.png:75,projectiles/fire-burst-small-5.png:75,projectiles/fire-burst-small-6.png:75,projectiles/fire-burst-small-7.png:75,projectiles/fire-burst-small-8.png:75" 
	[/item]
	#{BOB_DELAY 300}
	{BOB_FLOATING_LABEL side=$side_number x,y=$x1,$y1 "12" {COLOR_HARM}}
	{BOB_MODIFY_HITPOINTS -12 no 0}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=bomb_xy
		find_in=bomb_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]

# Net Trap

[event]
name=moveto
first_time_only=no
	[filter]
		canrecruit=yes
		[filter_location]
			find_in=net_xy
		[/filter_location]
		[filter_wml]
			[modifications]
				[trait]
					id=trapper
				[/trait]
			[/modifications]
		[/filter_wml]
	[/filter]
	{BOB_PRINT ("$character[$side_number].name has picked up a net trap")}
	{BOB_SOUND skeleton-hit-2.ogg}
	{VARIABLE_OP inventory[$side_number].net add 1}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=net_xy
		find_in=net_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]

[event]
name=moveto
first_time_only=no
	[filter]
		[filter_location]
			find_in=net_xy
		[/filter_location]
		[not]
			[filter_wml]
				[modifications]
					[trait]
						id=trapper
					[/trait]
				[/modifications]
			[/filter_wml]
		[/not]
	[/filter]
	{BOB_FLOATING_LABEL side=$side_number x,y=$x1,$y1 "Slowed" {COLOR_HARM}}
	{BOB_ALTER_STATUS x=$x1 y=$y1 slowed yes}
	{BOB_SOUND net.wav}
	{REMOVE_IMAGE $x1 $y1}
	[store_locations]
		variable=net_xy
		find_in=net_xy
		[not]
			x,y=$x1,$y1
		[/not]
	[/store_locations]
[/event]
#enddef

####################################################################################
# Concoction
####################################################################################
	
#define BOB_TALENT_CONCOCTION
[event]
	name=start
	
[set_menu_item]
	id=Concoction
	description=_ "menu^Use Concoction"
	image=misc/concoction.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals concoction}
		[have_unit]
			x,y=$x1,$y1
			side=$side_number
			canrecruit=yes
			[not]
				[filter_wml]
					moves=0
				[/filter_wml] 
			[/not]
		[/have_unit]
	[/show_if]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/concoction.png
	caption=_ "Concoction"
	message=_ "Concoction allows you to create potions by mixing two raw materials. Any potions you make will be added to your inventory."

[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
{VARIABLE finished yes}
[/command]
[/option]

# Red Potions

[option]
message= {MENU_IMG_TXT2 "icons/recipes/health_potion_recipe.png" "$inventory[$side_number].huanti_leaves / $inventory[$side_number].huanti_leaves / $inventory[$side_number].health_potion" _"<span color='{BOB_GREEN}'>Huanti Leaves + Huanti Leaves = Health Potion</span>
<span size='small'>Restores 6 hitpoints</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].huanti_leaves greater_than_equal_to 2}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].huanti_leaves add -2}
	{VARIABLE_OP inventory[$side_number].health_potion add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted a Health Potion")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/endurance_potion_recipe.png" "$inventory[$side_number].huanti_leaves / $inventory[$side_number].ulox_rock / $inventory[$side_number].endurance_potion" _"<span color='{BOB_GREEN}'>Huanti Leaves + Ulox Rock = Endurance Potion</span>
<span size='small'>Restores 10 hitpoints and adds 1 max hitpoint</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].huanti_leaves greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].huanti_leaves add -1}
	{VARIABLE_OP inventory[$side_number].ulox_rock add -1}
	{VARIABLE_OP inventory[$side_number].endurance_potion add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted an Endurance Potion")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/stamina_potion_recipe.png" "$inventory[$side_number].gold_nugget / $inventory[$side_number].ulox_rock / $inventory[$side_number].stamina_potion" _"<span color='{BOB_GREEN}'>Gold Nugget + Ulox Rock = Stamina Potion</span>
<span size='small'>Adds 3 max hitpoints</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].gold_nugget greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].ulox_rock greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].gold_nugget add -1}
	{VARIABLE_OP inventory[$side_number].ulox_rock add -1}
	{VARIABLE_OP inventory[$side_number].stamina_potion add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted a Stamina Potion")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/life_potion_recipe.png" "$inventory[$side_number].huanti_leaves / $inventory[$side_number].gold_nugget / $inventory[$side_number].life_potion" _"<span color='{BOB_GREEN}'>Huanti Leaves + Gold Nugget = Life Potion</span>
<span size='small'>Restores 20 hitpoints</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].gold_nugget greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].huanti_leaves greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].gold_nugget add -1}
	{VARIABLE_OP inventory[$side_number].huanti_leaves add -1}
	{VARIABLE_OP inventory[$side_number].life_potion add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted a Life Potion")}
[/command]
[/option]

# Purple Potions

[option]
message= {MENU_IMG_TXT2 "icons/recipes/brainhaste_tonic_recipe.png" "$inventory[$side_number].slime / $inventory[$side_number].yoll_tree_bark / $inventory[$side_number].brainhaste_tonic" _"<span color='{BOB_GREEN}'>Slime + Yoll Tree Bark = Brainhaste Tonic</span>
<span size='small'>Adds 4 experience</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].yoll_tree_bark greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].slime add -1}
	{VARIABLE_OP inventory[$side_number].yoll_tree_bark add -1}
	{VARIABLE_OP inventory[$side_number].brainhaste_tonic add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted a Brainhaste Tonic")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/mind_juice_recipe.png" "$inventory[$side_number].gold_nugget / $inventory[$side_number].yoll_tree_bark / $inventory[$side_number].mind_juice" _"<span color='{BOB_GREEN}'>Gold Nugget + Yoll Tree Bark = Mind Juice</span>
<span size='small'>-3 max experience</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].gold_nugget greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].yoll_tree_bark greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].gold_nugget add -1}
	{VARIABLE_OP inventory[$side_number].yoll_tree_bark add -1}
	{VARIABLE_OP inventory[$side_number].mind_juice add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted some Mind Juice")}
[/command]
[/option]

# Green Potions

[option]
message= {MENU_IMG_TXT2 "icons/recipes/antidote_recipe.png" "$inventory[$side_number].huanti_leaves / $inventory[$side_number].scorpion_tail / $inventory[$side_number].antidote" _"<span color='{BOB_GREEN}'>Huanti Leaves + Scorpion Tail = Antidote</span>
<span size='small'>Cures poison</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].huanti_leaves greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].huanti_leaves add -1}
	{VARIABLE_OP inventory[$side_number].scorpion_tail add -1}
	{VARIABLE_OP inventory[$side_number].antidote add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted an Antidote")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/speed_serum_recipe.png" "$inventory[$side_number].slime / $inventory[$side_number].scorpion_tail / $inventory[$side_number].speed_serum" _"<span color='{BOB_GREEN}'>Slime + Scorpion Tail = Speed Serum</span>
<span size='small'>Restores moves but poisons your metabolism</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].slime add -1}
	{VARIABLE_OP inventory[$side_number].scorpion_tail add -1}
	{VARIABLE_OP inventory[$side_number].speed_serum add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted some Speed Serum")}
[/command]
[/option]

# Blue Potions

[option]
message= {MENU_IMG_TXT2 "icons/recipes/energy_cocktail_recipe.png" "$inventory[$side_number].slime / $inventory[$side_number].gold_nugget / $inventory[$side_number].energy_cocktail" _"<span color='{BOB_GREEN}'>Slime + Gold Nugget = Energy Cocktail</span>
<span size='small'>Restores moves after next combat</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].gold_nugget greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].slime add -1}
	{VARIABLE_OP inventory[$side_number].gold_nugget add -1}
	{VARIABLE_OP inventory[$side_number].energy_cocktail add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted an Energy Cocktail")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/bloodlust_bile_recipe.png" "$inventory[$side_number].slime / $inventory[$side_number].fang / $inventory[$side_number].bloodlust_bile" _"<span color='{BOB_GREEN}'>Slime + Fang = Bloodlust Bile</span>
<span size='small'>You can attack twice</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].fang greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].fang add -1}
	{VARIABLE_OP inventory[$side_number].slime add -1}
	{VARIABLE_OP inventory[$side_number].bloodlust_bile add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted some Bloodlust Bile")}
[/command]
[/option]

[option]
message= {MENU_IMG_TXT2 "icons/recipes/frenzy_fluid_recipe.png" "$inventory[$side_number].gold_nugget / $inventory[$side_number].fang / $inventory[$side_number].frenzy_fluid" _"<span color='{BOB_GREEN}'>Gold Nugget + Fang = Frenzy Fluid</span>
<span size='small'>Your next combat will last two rounds</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].fang greater_than_equal_to 1}
	{BOB_CONDITION inventory[$side_number].gold_nugget greater_than_equal_to 1}
	[/show_if]
[command]
	{VARIABLE_OP inventory[$side_number].fang add -1}
	{VARIABLE_OP inventory[$side_number].gold_nugget add -1}
	{VARIABLE_OP inventory[$side_number].frenzy_fluid add 1}
	{BOB_PRINT ("$character[$side_number].name has concocted some Frenzy Fluid")}
[/command]
[/option]


[/message]
[/do]
[/while]
[/command]
[/set_menu_item]
[/event]
#enddef

####################################################################################
# Conjurer
####################################################################################

#define BOB_TALENT_CONJURER
[event]
	name=start

[set_menu_item]
	id=Conjure
	description=_ "menu^Conjure"
	image=misc/conjurer.png
	[show_if]
		{BOB_CONDITION character[$side_number].talent equals conjurer}
		[not]
			[have_unit]
				x,y=$x1,$y1
			[/have_unit]
		[/not]
	[/show_if]
	[filter_location]
		[not]
			terrain="Xt,Xu,Xv,*^Xo,Xos,Qt,Qlf,Ql,Qxu,Md^Xm,Mm^Xm,Wo,_off^_usr"
		[/not]
		[and]
			[filter]
				side=$side_number
				canrecruit=yes
				[not]
					[filter_wml]
						moves=0
					[/filter_wml] 
				[/not]
			[/filter]
			radius=1
		[/and]
	[/filter_location]
[command]

{VARIABLE finished no}
[while]
{BOB_CONDITION finished equals no}
[do]

[message]
	speaker=narrator
	image=icons/traits/conjurer.png
	caption=_ "Conjure"
	message=_ "Conjuring allows you to use raw materials from your inventory to create new units. Conjured units are not permanent: every turn there is a 30% chance the magic will wane and they will vanish."


[option]
message= {MENU_IMG_TXT2 "icons/blank-icon.png" " " _"Return To Game"}
[command]
{VARIABLE finished yes}
[/command]
[/option]

# Mudcrawler

[option]
message= {MENU_IMG_TXT2 "inventory/materials/clay.png" "$inventory[$side_number].clay" _"<span color='{BOB_GREEN}'>Use Clay</span>
<span size='small'>Creates a Mudcrawler</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].clay greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].clay add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Mudcrawler")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT "Mudcrawler"}
[/command]
[/option]

# Swampcrawler

[option]
message= {MENU_IMG_TXT2 "inventory/materials/slime.png" "$inventory[$side_number].slime" _"<span color='{BOB_GREEN}'>Use Slime</span>
<span size='small'>Creates a Swampcrawler</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].slime greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].slime add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Swampcrawler")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT "BOB_Swampcrawler"}
[/command]
[/option]

# Wolf

[option]
message= {MENU_IMG_TXT2 "inventory/materials/fang.png" "$inventory[$side_number].fang" _"<span color='{BOB_GREEN}'>Use Fang</span>
<span size='small'>Creates a Wolf</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].fang greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].fang add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Wose")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT Wolf}
[/command]
[/option]

# Lizard

[option]
message= {MENU_IMG_TXT2 "inventory/materials/lizard_tail.png" "$inventory[$side_number].lizard_tail" _"<span color='{BOB_GREEN}'>Use Lizard Tail</span>
<span size='small'>Creates a Saurian Skirmisher</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].lizard_tail greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].lizard_tail add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Saurian Skirmisher")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT "Saurian Skirmisher"}
[/command]
[/option]

# Skeleton

[option]
message= {MENU_IMG_TXT2 "inventory/materials/skull.png" "$inventory[$side_number].skull" _"<span color='{BOB_GREEN}'>Use Skull</span>
<span size='small'>Creates a Skeleton</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].skull greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].skull add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Skeleton")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT Skeleton}
[/command]
[/option]

# Giant Scorpion

[option]
message= {MENU_IMG_TXT2 "inventory/materials/scorpion_tail.png" "$inventory[$side_number].scorpion_tail" _"<span color='{BOB_GREEN}'>Use Scorpion Tail</span>
<span size='small'>Creates a Giant Scorpion</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].scorpion_tail greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].scorpion_tail add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Giant Scorpion")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT "Giant Scorpion"}
[/command]
[/option]

# Wose Sapling

[option]
message= {MENU_IMG_TXT2 "inventory/materials/yoll_tree_bark.png" "$inventory[$side_number].yoll_tree_bark" _"<span color='{BOB_GREEN}'>Use Yoll Tree Bark</span>
<span size='small'>Creates a Wose Sapling</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].yoll_tree_bark greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].yoll_tree_bark add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Wose Sapling")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT "BOB_Wose Sapling"}
[/command]
[/option]

# Fire Dragon

[option]
message= {MENU_IMG_TXT2 "inventory/materials/dragon_tail.png" "$inventory[$side_number].dragon_tail" _"<span color='{BOB_GREEN}'>Use Dragon Tail</span>
<span size='small'>Creates a Fire Dragon</span>"}
[show_if]
	{BOB_CONDITION inventory[$side_number].dragon_tail greater_than_equal_to 1}
[/show_if]
[command]
{VARIABLE_OP inventory[$side_number].dragon_tail add -1}
#{BOB_PRINT ("$character[$side_number].name has conjured a Fire Dragon")}
{VARIABLE finished yes}
{BOB_CREATE_CONJURED_UNIT "Fire Dragon"}
[/command]
[/option]

[/message]
[/do]
[/while]
[/command]
[/set_menu_item]

[/event]

# Test if the creature vanishes

[event]
    name="side turn"
    first_time_only=no
   
	[store_unit]
		[filter]
			ability=conjured
			side=$side_number
		[/filter]
		variable=conjured
		kill=no
	[/store_unit]

	{FOREACH conjured i}
		   
		{RANDOM 1..10}
	   
		[if]
			{BOB_CONDITION random less_than_equal_to 3}
			[then]
				{VARIABLE temp_x $conjured[$i].x}
				{VARIABLE temp_y $conjured[$i].y}
				{SCROLL_TO $conjured[$i].x $conjured[$i].y}
				[unstore_unit]
					variable=conjured[$i]
				[/unstore_unit]
				{BOB_SOUND magic-missile-1-miss.ogg,magic-missile-2-miss.ogg,magic-missile-3-miss.ogg}
				[kill]
					x,y=$temp_x,$temp_y
					animate=yes
				[/kill]
			[/then]
		[/if]
		[if]
			{BOB_CONDITION random greater_than 3}
			[then]
				[unstore_unit]
					variable=conjured[$i]
				[/unstore_unit]
			[/then]
		[/if]
	{NEXT i}

	{CLEAR_VARIABLE random}
	{CLEAR_VARIABLE conjured}
	{CLEAR_VARIABLE temp_x}
	{CLEAR_VARIABLE temp_y}
   
[/event]
#enddef
